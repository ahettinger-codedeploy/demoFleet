YUI.add("squarespace-calendar-block-renderer",function(a){a.namespace("Y.Squarespace.Rendering");var g=YUI_CONFIG.classNamePrefix||"yui3",b=a.Base.create("SqspCalendarPlugin",a.Squarespace.CalendarBaseRenderer,[],{initializer:function(a){this.host.get("contentBox").delegate("hover",this._onHover,this._onHoverOut,"."+g+"-calendar-day",this)},_renderDay:function(c,d,e){0<e.length&&(c=this._groupEvents(e,c),c=this._createFlyoutNode(c),d.addClass("date-has-event"),d.append(a.Node.create(b.TEMPLATE_DAY_MARKER)),
d.append(c))},_onHover:function(a){a=a.target;var b=a.one(".event-menu"),e=this.host.get("contentBox");b&&(b.show(),b.get("offsetWidth")+a.getX()>e.getX()+e.get("offsetWidth")&&b.addClass("event-menu-right"))},_onHoverOut:function(a){a=a.target;(a=a.hasClass("event-menu")?a:a.one(".event-menu"))&&a.hide()},_groupEvents:function(b,d){var e={},f=[],h=[];a.Array.each(b,function(a){if(this._isSameDay(a,d)){var b=this._getEventDisplayTime(a),c=e[b];c||(c=[],e[b]=c);c.push(a)}else f.push(a)},this);a.Object.each(e,
function(a,b){h.splice(0,0,{displayTime:b,events:a})});0<f.length&&h.splice(0,0,{displayTime:"(from previous day)",events:f});return h},_createFlyoutNode:function(c){var d=a.Node.create(b.TEMPLATE_FLYOUT);a.Array.each(c,function(c){var f=a.Node.create(a.substitute(b.TEMPLATE_GROUP_NODE,{displayTime:c.displayTime}));d.append(f);a.Array.each(c.events,function(c){c=a.substitute(b.TEMPLATE_EVENT_NODE,{fullUrl:c.fullUrl,title:c.title});f.append(c)})});d.hide();return d}},{TEMPLATE_DAY_MARKER:'<div class="date-has-event-marker"></div>',
TEMPLATE_FLYOUT:'<div class="event-menu">',TEMPLATE_GROUP_NODE:'<div class="event-time-group" title="{displayTime}"><div class="event-time">{displayTime}</div></div>',TEMPLATE_EVENT_NODE:'<div class="event-item"><a class="event-link" href="{fullUrl}">{title}</a></div>',NS:"calendarPlugin"});a.namespace("Squarespace.Rendering").renderCalendar=function(c,d){var e;if(a.Lang.isString(d))collectionid=d;else if(a.Object.hasKey(d,"collectionId"))e=d.collectionId;else if(a.instanceOf(d,a.Squarespace.Models.ContentCollection))e=
d.get("id");else{console.warn("Cannot render calendar: failed to determine collectionId");return}e=new a.Squarespace.SquarespaceCalendar({contentBox:c,date:new Date,collectionId:e});e.plug(b);e.render();return e};with(a.config.win)Squarespace.onInitialize(a,function(){var b=a.all(".sqs-block.calendar-block[data-block-json]");b.size()&&b.each(function(b){a.Squarespace.Rendering.renderCalendar(b.one(".sqs-block-content"),a.JSON.parse(b.getAttribute("data-block-json")))},this)})},"1.0",{requires:["squarespace-calendar-core-renderer"]});
YUI.add("squarespace-calendar-core-renderer",function(a){var g=function(b){return b.recordType===a.Squarespace.RecordType.EVENT?b.startDate:b.addedOn};a.Squarespace.SquarespaceCalendar=a.Base.create("SquarespaceCalendar",a.Calendar,[],{initializer:function(){this._fetchEvents()},bindUI:function(){a.Calendar.superclass.bindUI.call(this);this.before("dateChange",this._clearEvents,this);this.after("dateChange",this._fetchEvents,this);this.after("collectionIdChange",this._fetchEvents,this)},_clearEvents:function(){this.set("events",
[])},_fetchEvents:function(){var b=this.get("date"),b=a.DataType.Date.format(b,{format:"%B-%Y",locale:"en"});a.Data.get({url:this._getFetchUrl(b),success:this._parseResponse,failure:this._handleResponseError},this)},_parseResponse:function(a){this.set("events",a)},_handleResponseError:function(b){console.error("Failed fetch data: "+b);(new a.Squarespace.Alert).show("Server Request Failed","Failed to get calender data, "+b.message)},_getFetchUrl:function(a){return"/api/open/GetItemsByMonth?collectionId="+
this.get("collectionId")+"&month="+a}},{ATTRS:{events:{value:[],validator:a.Lang.isArray},collectionId:{value:null,validator:a.Lang.isString}}});a.Squarespace.CalendarBaseRenderer=a.Base.create("CalendarBaseRenderer",a.Plugin.Base,[],{initializer:function(a){this.host=a.host;this.afterHostEvent("eventsChange",this._onEventsChange,this)},_onEventsChange:function(b){var c=null;a.Lang.isArray(b.newVal)&&0<b.newVal.length&&(c=a.bind(this._calendarFilterFunction,this));this.host.set("customRenderer",{rules:{all:"events"},
filterFunction:c})},_calendarFilterFunction:function(a,c,d){d=this.host.get("events");d=this._getEventsOfDay(d,a);this._sortEvents(d);this._renderDay(a,c,d)},_renderDay:function(a,c,d){0<d.length&&c.setStyle("background","gray")},_sortEvents:function(a){a.sort(function(a,b){var e=g(a);return g(b)-e})},_getEventsOfDay:function(b,c){var d=a.DataType.Date.format(c,{format:"%Y-%m-%d"});return a.Lang.isArray(b)&&0<b.length?a.Array.filter(b,function(a){return this._isEventPartOfDay(a,d)},this):[]},_isEventPartOfDay:function(b,
c){var d,e;if(b.recordType!==a.Squarespace.RecordType.EVENT)return d=a.Squarespace.DateUtils.dateFormat(b.addedOn,{format:"%Y-%m-%d"}),d===c;d=a.Squarespace.DateUtils.dateFormat(b.startDate,{format:"%Y-%m-%d"});e=a.Squarespace.DateUtils.dateFormat(b.endDate,{format:"%Y-%m-%d"});return c==d||c==e||new Date(c)>new Date(d)&&new Date(c)<new Date(e)?!0:!1},_getEventDisplayTime:function(b){b=g(b);return a.Squarespace.DateUtils.dateFormat(b,{format:"%l:%M%P"}).trim()},_isSameDay:function(b,c){if(b.recordType!==
a.Squarespace.RecordType.EVENT)return!0;var d=a.Squarespace.DateUtils.dateFormat(b.startDate,{format:"%Y-%m-%d"}),e=a.DataType.Date.format(c,{format:"%Y-%m-%d"});return d===e}},{NS:"calendarPlugin"})},"1.0",{requires:["calendar","node","squarespace-ui-base","squarespace-date-utils"]});
