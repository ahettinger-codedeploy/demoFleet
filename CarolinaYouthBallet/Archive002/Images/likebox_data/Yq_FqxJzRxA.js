/*1329433759,169776321*/

if (window.CavalryLogger) { CavalryLogger.start_js(["lqJkj"]); }

__e("GenderConst",[],function(a,b,c,d,e,f){var g={UNKNOWN:0,FEMALE_SINGULAR:1,MALE_SINGULAR:2,FEMALE_SINGULAR_GUESS:3,MALE_SINGULAR_GUESS:4,MIXED_SINGULAR:5,MIXED_PLURAL:5,NEUTER_SINGULAR:6,UNKNOWN_SINGULAR:7,FEMALE_PLURAL:8,MALE_PLURAL:9,NEUTER_PLURAL:10,UNKNOWN_PLURAL:11};a.GenderConst=e.exports=g;},3);
__e("notifications-counter",["Arbiter","DocumentTitle","JSLogger"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('DocumentTitle'),i=b('JSLogger'),j={messages:0,notifications:0,requests:0};a.NotificationCounter=e.exports={init:function(){g.subscribe('update_title',this._handleUpdate.bind(this));g.subscribe('jewel/count-updated',this._handleCountUpdate.bind(this));},getCount:function(){var k=0;for(var l in j){var m=Number(j[l]);if(typeof j[l]=='string'&&isNaN(m))return j[l];if(isNaN(m)||m<0){i.create('jewels').error('bad_count',{jewel:l,count:j[l]});continue;}k+=m;}return k;},updateTitle:function(){var k=this.getCount(),l=h.get();l=k?'('+k+') '+l:l;h.set(l,true);},_handleCountUpdate:function(k,l){j[l.jewel]=l.count;this.updateTitle();},_handleUpdate:function(k,l){this.updateTitle();}};},3);
var ConnectDialog={newInstance:function(a,b,c,d,e,f,g,h,i,j,k){var l=new Dialog(),m=new AsyncRequest().setURI('/ajax/profile/connect.php').setData({dialog:1,profile_id:a,source:b,pymk_score:g,pymk_source:h,pymk_page:i,show_confirmation_optout:j,precheck_confirmation_optout:k}).setFinallyHandler(function(){var p=l.getButtonElement('connect');if(p)p.focus();});for(var n in f)m.setContextData(n,f[n]);l.setAsync(m);var o={ondone_func:c,ondone_data:d,ondone_reload:e,pymk_score:g,pymk_source:h,pymk_page:i};ConnectDialog.prepare(l,o);return l;},prepare:function(a,b){copy_properties(a,b||{});a.setCloseHandler(ConnectDialog.deleteInstance);ConnectDialog.setInstance(a);},deleteInstance:function(){delete ConnectDialog.instance;},setInstance:function(a){ConnectDialog.instance=a;},getInstance:function(){return ConnectDialog.instance;}};
window.__UIControllerRegistry=window.__UIControllerRegistry||{};
(function(){FbDesktopPlugin={_plugin:'_not_checked',getPlugin:function(){if(this._plugin==='_not_checked'){this._plugin=null;if(FbDesktopDetect.isPluginInstalled()){var a=DOM.create('div');document.body.appendChild(a);DOM.setContent(a,HTML('<object id="kiwi_plugin" '+'type="'+FbDesktopDetect.mimeType+'" width="0" height="0">'+'</object>'));this._plugin=$('kiwi_plugin');}}return this._plugin;},isAppRunning:function(){var a=this.getPlugin();return a&&'isAppRunning' in a&&a.isAppRunning();},logout:function(a){a=a||"0";var b=this.getPlugin();if(b)b.logout(a);},shouldSuppressBeeper:function(){return this.isAppRunning();},shouldSuppressSidebar:function(){var a=this.getPlugin();return a&&'isAppDocked' in a&&a.isAppDocked();},transferAuthToken:function(a,b){if(a&&a.length>0){var c=this.getPlugin();if(c)c.setAccessToken(a,b);}if(this.redirectHome)window.location.href=URI().setPath().toString();}};})();
/**
 * @provides md5
 * @option preserve-header
 *
 * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
 * Digest Algorithm, as defined in RFC 1321.
 * Version 2.2 Copyright (C) Paul Johnston 1999 - 2009
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for more info.
 */(function(){window.md5=function(o){return c(b(d(o)));};var a=0;function b(o){return f(g(e(o),o.length*8));}function c(o){try{a;}catch(p){a=0;}var q=a?"0123456789ABCDEF":"0123456789abcdef",r="",s;for(var t=0;t<o.length;t++){s=o.charCodeAt(t);r+=q.charAt((s>>>4)&15)+q.charAt(s&15);}return r;}function d(o){var p="",q=-1,r,s;while(++q<o.length){r=o.charCodeAt(q);s=q+1<o.length?o.charCodeAt(q+1):0;if(55296<=r&&r<=56319&&56320<=s&&s<=57343){r=65536+((r&1023)<<10)+(s&1023);q++;}if(r<=127){p+=String.fromCharCode(r);}else if(r<=2047){p+=String.fromCharCode(192|((r>>>6)&31),128|(r&63));}else if(r<=65535){p+=String.fromCharCode(224|((r>>>12)&15),128|((r>>>6)&63),128|(r&63));}else if(r<=2097151)p+=String.fromCharCode(240|((r>>>18)&7),128|((r>>>12)&63),128|((r>>>6)&63),128|(r&63));}return p;}function e(o){var p=Array(o.length>>2);for(var q=0;q<p.length;q++)p[q]=0;for(var q=0;q<o.length*8;q+=8)p[q>>5]|=(o.charCodeAt(q/8)&255)<<(q%32);return p;}function f(o){var p="";for(var q=0;q<o.length*32;q+=8)p+=String.fromCharCode((o[q>>5]>>>(q%32))&255);return p;}function g(o,p){o[p>>5]|=128<<((p)%32);o[(((p+64)>>>9)<<4)+14]=p;var q=1732584193,r=-271733879,s=-1732584194,t=271733878;for(var u=0;u<o.length;u+=16){var v=q,w=r,x=s,y=t;q=i(q,r,s,t,o[u+0],7,-680876936);t=i(t,q,r,s,o[u+1],12,-389564586);s=i(s,t,q,r,o[u+2],17,606105819);r=i(r,s,t,q,o[u+3],22,-1044525330);q=i(q,r,s,t,o[u+4],7,-176418897);t=i(t,q,r,s,o[u+5],12,1200080426);s=i(s,t,q,r,o[u+6],17,-1473231341);r=i(r,s,t,q,o[u+7],22,-45705983);q=i(q,r,s,t,o[u+8],7,1770035416);t=i(t,q,r,s,o[u+9],12,-1958414417);s=i(s,t,q,r,o[u+10],17,-42063);r=i(r,s,t,q,o[u+11],22,-1990404162);q=i(q,r,s,t,o[u+12],7,1804603682);t=i(t,q,r,s,o[u+13],12,-40341101);s=i(s,t,q,r,o[u+14],17,-1502002290);r=i(r,s,t,q,o[u+15],22,1236535329);q=j(q,r,s,t,o[u+1],5,-165796510);t=j(t,q,r,s,o[u+6],9,-1069501632);s=j(s,t,q,r,o[u+11],14,643717713);r=j(r,s,t,q,o[u+0],20,-373897302);q=j(q,r,s,t,o[u+5],5,-701558691);t=j(t,q,r,s,o[u+10],9,38016083);s=j(s,t,q,r,o[u+15],14,-660478335);r=j(r,s,t,q,o[u+4],20,-405537848);q=j(q,r,s,t,o[u+9],5,568446438);t=j(t,q,r,s,o[u+14],9,-1019803690);s=j(s,t,q,r,o[u+3],14,-187363961);r=j(r,s,t,q,o[u+8],20,1163531501);q=j(q,r,s,t,o[u+13],5,-1444681467);t=j(t,q,r,s,o[u+2],9,-51403784);s=j(s,t,q,r,o[u+7],14,1735328473);r=j(r,s,t,q,o[u+12],20,-1926607734);q=k(q,r,s,t,o[u+5],4,-378558);t=k(t,q,r,s,o[u+8],11,-2022574463);s=k(s,t,q,r,o[u+11],16,1839030562);r=k(r,s,t,q,o[u+14],23,-35309556);q=k(q,r,s,t,o[u+1],4,-1530992060);t=k(t,q,r,s,o[u+4],11,1272893353);s=k(s,t,q,r,o[u+7],16,-155497632);r=k(r,s,t,q,o[u+10],23,-1094730640);q=k(q,r,s,t,o[u+13],4,681279174);t=k(t,q,r,s,o[u+0],11,-358537222);s=k(s,t,q,r,o[u+3],16,-722521979);r=k(r,s,t,q,o[u+6],23,76029189);q=k(q,r,s,t,o[u+9],4,-640364487);t=k(t,q,r,s,o[u+12],11,-421815835);s=k(s,t,q,r,o[u+15],16,530742520);r=k(r,s,t,q,o[u+2],23,-995338651);q=l(q,r,s,t,o[u+0],6,-198630844);t=l(t,q,r,s,o[u+7],10,1126891415);s=l(s,t,q,r,o[u+14],15,-1416354905);r=l(r,s,t,q,o[u+5],21,-57434055);q=l(q,r,s,t,o[u+12],6,1700485571);t=l(t,q,r,s,o[u+3],10,-1894986606);s=l(s,t,q,r,o[u+10],15,-1051523);r=l(r,s,t,q,o[u+1],21,-2054922799);q=l(q,r,s,t,o[u+8],6,1873313359);t=l(t,q,r,s,o[u+15],10,-30611744);s=l(s,t,q,r,o[u+6],15,-1560198380);r=l(r,s,t,q,o[u+13],21,1309151649);q=l(q,r,s,t,o[u+4],6,-145523070);t=l(t,q,r,s,o[u+11],10,-1120210379);s=l(s,t,q,r,o[u+2],15,718787259);r=l(r,s,t,q,o[u+9],21,-343485551);q=m(q,v);r=m(r,w);s=m(s,x);t=m(t,y);}return Array(q,r,s,t);}function h(o,p,q,r,s,t){return m(n(m(m(p,o),m(r,t)),s),q);}function i(o,p,q,r,s,t,u){return h((p&q)|((~p)&r),o,p,s,t,u);}function j(o,p,q,r,s,t,u){return h((p&r)|(q&(~r)),o,p,s,t,u);}function k(o,p,q,r,s,t,u){return h(p^q^r,o,p,s,t,u);}function l(o,p,q,r,s,t,u){return h(q^(p|(~r)),o,p,s,t,u);}function m(o,p){var q=(o&65535)+(p&65535),r=(o>>16)+(p>>16)+(q>>16);return (r<<16)|(q&65535);}function n(o,p){return (o<<p)|(o>>>(32-p));}})();
PageletCache=window.PageletCache||{libraryHash:'48c1e150e2f733fcc1fac1b62d944806',init:function(a){PageletCache._password=a;try{PageletCache._cache=window.localStorage;}catch(b){}PageletCache.loadCryptoLib();Arbiter.subscribe('pre_page_transition',PageletCache.cleanup);},loadCryptoLib:function(){var a=PageletCache._cache.getItem('crypto-lib');if(!a){Bootloader.loadComponents('async',function(){new AsyncRequest(PageletCache._crypto_url).setHandler(function(b){PageletCache.evalJS(b.payload);onafterloadRegister_DEPRECATED(function(){PageletCache._cache.setItem('crypto-lib',b.payload);});}).send();});}else{if(Math.random()<.1&&PageletCache.libraryHash!=md5(a)){PageletCache._cache.removeItem('crypto-lib');PageletCache.loadCryptoLib();return;}PageletCache.evalJS(a);}},evalJS:function(a){eval_global(a);Arbiter.inform('pagelet_cache_loaded',true,Arbiter.BEHAVIOR_STATE);},_processBeforeWrite:function(a){Bootloader.setResourceMap(a.resource_map);var b=(a.css||[]).concat(a.js||[]);for(var c in (a.bootloadable||{}))b.concat(a.bootloadable[c]);a.resource_map=a.resource_map||{};for(var d=0;d<b.length;d++){var e=b[d];if(!a.resource_map[e])a.resource_map[e]=Bootloader.resolveResources([e])[0];}if(a.cache_type=='overwrite'){delete a.onload;delete a.onafterload;delete a.jscc;delete a.jscc_map;delete a.jscalls;}},write:function(a){if(!PageletCache._cache||a.cache_type=='base')return;Arbiter.registerCallback(function(){var b={},c={};copy_properties(c,a);try{PageletCache._processBeforeWrite(c);b[a.key]=c;var e=sjcl.encrypt(PageletCache._password,JSON.stringify(b));PageletCache._cache.setItem(a.id,e);PageletCache._pagelets[a.id]=c;}catch(d){window.Util&&false;}},['pagelet_cache_loaded']);},loadFromCache:function(a){var b={};copy_properties(b,PageletCache.read(a.id,a.key));if(is_empty(b))PageletCache.bustcache();b.id=a.id;b.cache_hit=true;b.display_dependency=a.display_dependency;b.phase=a.phase;b.is_last=a.is_last;return b;},read:function(a,b){if(!PageletCache._cache)return null;if(a.substr(0,6)=='cached')a=a.substr(7);var c=PageletCache._cache.getItem(a);if(c){var d;try{var f=sjcl.decrypt(PageletCache._password,c);d=JSON.parse(f);}catch(e){window.Util&&false;}if(d&&d[b]){PageletCache._pagelets[a]=d[b];PageletCache._cache_hits[a]=true;return d[b];}}},bustcache:function(){Bootloader.loadComponents(['uri','cookie'],function(){setCookie('bustcache',1,1000);URI.getNextURI().go();});},isCacheHit:function(a){return !!PageletCache._cache_hits[a];},cleanup:function(){PageletCache._cache_hits={};},clearCache:function(){if(PageletCache._cache){var a=[];for(var b=0;b<PageletCache._cache.length;b++){var c=PageletCache._cache.key(b);if(c.substr(0,7)=='pagelet')a.push(c);}for(b=0;b<a.length;b++)PageletCache._cache.removeItem(a[b]);}},_cache:null,_crypto_url:'/ajax/pagelet_cache/crypto.php',_pagelets:{},_cache_hits:{}};
function PageletCacheController(a,b,c){if(!PageletCache)return;if(!a)return;this._cacheKey=a;this._cacheType=b;this._subscriptions=[];this._controller=null;this._registerSnapshot(c);PageletCacheController._instances[a]=this;}copy_properties(PageletCacheController,{registerController:function(a,b){if(!a||!b)return null;var c=PageletCacheController._instances[a];if(c){c.setController(b);if(c._cacheType=='update'&&PageletCache.isCacheHit(a))onafterloadRegister_DEPRECATED(c.updateAfterload.bind(c,b));}return c;},_instances:{}});copy_properties(PageletCacheController.prototype,{registerCleanup:function(a){Arbiter.subscribe(a,this._cleanup.bind(this));},setController:function(a){this._controller=a;return this;},loadData:function(){return PageletCache.fetchData(this._cacheKey);},populateControllerDataOnSnapshot:bagofholding,handlePageletDOMOnSnapshot:bagofholding,updateAfterload:bagofholding,_registerSnapshot:function(a){for(var b=0;b<a.length;b++)this._subscriptions.push(Arbiter.subscribe(a[b],this._update.bind(this)));},_update:function(){if(!$(this._cacheKey)){this._cleanup();return;}var a=this._controller?this.populateControllerDataOnSnapshot.bind(this,this._controller):bagofholding;PageletCache.takeSnapshot(this._cacheKey,a,this.handlePageletDOMOnSnapshot.bind(this));},_cleanup:function(){this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions.length=0;delete PageletCacheController._instances[this._cacheKey];}});copy_properties(PageletCache,{takeSnapshot:function(a,b,c){var d=PageletCache._pagelets[a];if(d){var e=$(a);if(e){var f=e.cloneNode(true);if(c)c(f);d.content[a]=f.innerHTML;if(b){if(!d.data)d.data={};b(d.data);}PageletCache.write(d);}}},fetchData:function(a,b){var c=PageletCache._pagelets[a];if(c&&c.data)if(b){return c.data[b];}else return c.data;}});
function HomeNavigationCache(a,b,c){this.parent.construct(this,a,b,c);}Class.extend(HomeNavigationCache,'PageletCacheController');copy_properties(HomeNavigationCache.prototype,{handlePageletDOMOnSnapshot:function(a){var b=DOM.scry(a,'li.sideNavItem');if(b.length===0)return;for(var c=0;c<b.length;c++){var d=b[c];if(d.id=='navItem_app_4748854339'){CSS.addClass(d,'selectedItem');}else if(CSS.hasClass(d,'selectedItem')){CSS.removeClass(d,'selectedItem');CSS.removeClass(d,'open');}CSS.removeClass(d,'loading');}}});
var NewHigh={reset:function(){this.initialized=false;},ensureInitialized:function(){if(this.initialized)return;this.button=DOM.scry(document.body,'a.stream_header_button')[0];this.composer=DOM.scry(document.body,'div.UIComposer')[0];this.buttonArea=DOM.scry(this.composer,'div.UIComposer_ButtonArea')[0];this.initialized=true;},showComposer:function(a){this.ensureInitialized();if(this.composer){CSS.show(this.composer);UIComposer.focusInstance(this.composer.id);var b=UIComposer.getInstance(this.composer.id);b&&b.loadAttachment(parseInt(a,10));}this.button&&CSS.hide(this.button);},hideComposer:function(a){this.ensureInitialized();if(this.composer){var b=UIComposer.getInstance(this.composer.id);if(!a){b&&b.initialized&&b.blur();CSS.hide(this.composer);this.button&&CSS.show(this.button);}else{b&&b.initialized&&b.loadAttachment(0);CSS.show(this.composer);this.buttonArea&&CSS.hide(this.buttonArea);}}}};
function FutureHomeSideNav(){this.parent.construct(this);}Class.extend(FutureHomeSideNav,'FutureSideNav');FutureHomeSideNav.prototype={init:function(){this.parent.init.apply(this,arguments);this.ajaxPipe=true;this.seeAllEndpoint="/ajax/home/generic.php";this.typeSections={favorites:'pinnedNav',profiles:'pinnedNav',apps:'appsNav',groups:'groupsNav',pages:'pagesNav',lists:'listsNav',interests:'interestsNav',connect_apps:'connectNav'};this.switchingFromTitanFixedFrame=false;this._arbiterSubscriptions.push(Arbiter.subscribe('titan_fixed_frame_changed',this.handleFixedFrameChanged.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FAVORITE_UPDATE,this.updateFavorite.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FIRST_RESPONSE,this.navigationFirstResponse.bind(this)));this._ensureHover('homeSideNav');this._initPageletCache();},_initPageletCache:function(a){if(window.PageletCacheController){this._cache=PageletCacheController.registerController('pagelet_navigation',this);if(this._cache){this._cache.registerCleanup('HomeNav/cleanup');onleaveRegister(function(){Arbiter.inform('HomeNav/cleanup');});}}},initMoreLink:function(a){this._eventHandlers.push(Event.listen(a,'click',this._showMoreSections.bind(this,a)));},_showMoreSections:function(a){var b=DOM.scry(this.root,'div.belowThreshold');CSS.hide(a);b.forEach(function(c){CSS.removeClass(c,'belowThreshold');});},handleFixedFrameChanged:function(a,b,c){if(b){var d=function(e,f){UIPagelet.loadFromEndpoint(e,f,{fixed_frame:b,selected_key:c});};d('PinnedNavigationPagelet','pagelet_pinned_nav');d('BookmarkNavigationPagelet','pagelet_bookmark_nav');if(ge('chatFriendsOnline'))CSS.hide(ge('chatFriendsOnline'));}else this.switchingFromTitanFixedFrame=true;},handlePageTransition:function(a){if(this.switchingFromTitanFixedFrame){this.switchingFromTitanFixedFrame=false;return false;}else return this.parent.handlePageTransition(a);},_initSection:function(a){var b=this.parent._initSection(a);for(var c in this.typeSections){var d=this.typeSections[c];if(b.id==d){var e=DOM.scry(b.node,'div.navHeader')[0];if(e){var f='\/bookmarks\/('+c+')(\/)?';b.seeall=this._initItem({node:e,id:b.id,endpoint:this.seeAllEndpoint,key:['bookmarks'],path:[{regex:f}]});}}}return b;},_constructItem:function(a,b){return new FutureHomeSideNavItem(a,b);},_constructSection:function(a){return new FutureHomeSideNavSection(a);},getSection:function(a){return this.typeSections[a]&&this.sections[this.typeSections[a]];},_getItemForKey:function(a){var b=this.parent._getItemForKey("nf");if(b&&b.matchKey(a)){return b;}else return this.parent._getItemForKey(a);},_isCurrentPath:function(a){return ((a.getDomain()===this.uri.getDomain())&&(a.getPath()==='/'||a.getPath()==='/home.php'));},_handleMenuClick:function(a,b,c,event){if(CSS.hasClass(c,'favorite')){Arbiter.inform(NavigationMessage.NAVIGATION_FAVORITE_UPDATE,{key:b.numericKey,favorite:!a.equals(this.getSection("favorites"))});}else this.parent._handleMenuClick(a,b,c,event);},removeItemByKey:function(a){Arbiter.inform(NavigationMessage.NAVIGATION_ITEM_REMOVED,a);this.parent.removeItemByKey(a);},toggleItemByKey:function(a,b){var c=this.getNodeForKey(a);if(!b){Arbiter.inform(NavigationMessage.NAVIGATION_ITEM_HIDDEN,a);c&&CSS.hide(c);}else c&&CSS.show(c);var d=this._getItemForKey(a);this.getSection(d.type).refresh();},removeItem:function(a){var b=this.getSection(a.type);this.parent.removeItem(a);b.refresh();},updateFavorite:function(a,b){var c=this._findItem(function(h){return h.matchKey(b.key)&&h.canFavorite();}),d=this.getSection("favorites"),e=bagofholding,f=b.favorite?d.addEndpoint:d.removeEndpoint;if(!c){if(b.favorite){e=function(){UIPagelet.loadFromEndpoint('PinnedNavigationPagelet','pagelet_pinned_nav');};}else e=function(){UIPagelet.loadFromEndpoint('BookmarkNavigationPagelet','pagelet_bookmark_nav');};}else{var g=this.getSection(c.type);if(b.favorite){CSS.show(c.node);this.moveItem(d,c);c.showFavorite();}else if(!g.equals(d)){this.moveItem(g,c);c.hideFavorite();}else this.removeItem(c);g.refresh();d.refresh();b.key=c.numericKey;Arbiter.inform('NavigationMessage.FAVORITES_UPDATED');}new AsyncRequest().setURI(f).setData({id:b.key}).setHandler(e).send();},_doPageTransition:function(a,b){this._unloadStreams();var c=this.parent._doPageTransition(a,b);if(c&&(a.type=='groups'||a.type=='lists'||a.type=='interests')){a.setCount(0);a.hideUnreadDot();}return c;},_unloadStreams:function(){var a=UIIntentionalStream&&UIIntentionalStream.instances,b=['nile','global','friends','blade'];a&&b.forEach(function(c){a[c]&&a[c].unload();});},navigationFirstResponse:function(){this.setSelected(this.loading);}};function FutureHomeSideNavSection(a){this.parent.construct(this,a);this.editEndpoint='/ajax/bookmark/edit/';this.addEndpoint='/ajax/bookmark/add/';this.removeEndpoint='/ajax/bookmark/delete/';}Class.extend(FutureHomeSideNavSection,'FutureSideNavSection');FutureHomeSideNavSection.prototype={refresh:function(){var a=DOM.scry(this.node,'li.sideNavItem'),b=DOM.scry(this.node,'div.actionLinks'),c=a.some(CSS.shown);CSS.conditionShow(DOM.find(this.node,'div.navHeader'),c);b.length&&CSS.conditionShow(b[0],c);}};function FutureHomeSideNavItem(a,b){this.parent.construct(this,a,b);}Class.extend(FutureHomeSideNavItem,'FutureSideNavItem');FutureHomeSideNavItem.prototype={canFavorite:function(){return !!this._getFavoriteLabel();},showFavorite:function(){DOM.setContent(this._getFavoriteLabel(),"Remove from Favorites");},hideFavorite:function(){DOM.setContent(this._getFavoriteLabel(),"Add to Favorites");},hideUnreadDot:function(){var a=DOM.scry(this.node,'img.unreadDot')[0];a&&CSS.hide(a);},_getFavoriteLabel:function(){return DOM.scry(this.node,'li.favorite span.itemLabel')[0];}};
function RenderManager(a){copy_properties(this,{_isDirty:false,_obj:a});}copy_properties(RenderManager.prototype,{dirty:function(){if(!this._isDirty){this._isDirty=true;bind(this,this.doPaint).defer();}},doPaint:function(){this._isDirty=false;this._obj.paint();}});
function CounterDisplay(a,b,c,d,e,f){copy_properties(this,{_name:a,_valueNode:$(b),_wrapperNode:$(c)||null,_statusClass:e,_rm:new RenderManager(this),_arbiterSubscription:null,_count:0});var g=this._valueNode.firstChild;if(g){var h=parseInt(g.nodeValue,10);if(!isNaN(h))this._count=h;}this._statusNode=d?$(d):null;this._subscribeAll();CounterDisplay.instances.push(this);if(!f)onleaveRegister(this._destroy.bind(this),true);}copy_properties(CounterDisplay,{EVENT_TYPE_ADJUST:'CounterDisplay/adjust',EVENT_TYPE_UPDATE:'CounterDisplay/update',instances:[],adjustCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_ADJUST+'/'+a,b);},setCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_UPDATE+'/'+a,b);}});Class.mixin(CounterDisplay,{_destroy:function(){delete this._valueNode;delete this._wrapperNode;if(this._arbiterSubscription){Arbiter.unsubscribe(this._arbiterSubscription);delete this._arbiterSubscription;}CounterDisplay.instances.remove(this);},adjustCount:function(a){this._count=Math.max(0,this._count+a);this._rm.dirty();return this;},setCount:function(a){this._count=Math.max(0,a);this._rm.dirty();return this;},paint:function(){DOM.setContent(this._valueNode,this._count);this._toggleNodes();},_toggleNodes:function(){if(this._wrapperNode)CSS.conditionClass(this._wrapperNode,'hidden_elem',this._count<=0);if(this._statusClass&&this._statusNode)CSS.conditionClass(this._statusNode,this._statusClass,this._count>0);},_subscribeAll:function(){var a=[CounterDisplay.EVENT_TYPE_ADJUST+'/'+this._name,CounterDisplay.EVENT_TYPE_UPDATE+'/'+this._name];this._arbiterSubscription=Arbiter.subscribe(a,this._onInform.bind(this),Arbiter.SUBSCRIBE_NEW);},_onInform:function(a,b){b=parseInt(b);if(isNaN(b))return;if(a.indexOf(CounterDisplay.EVENT_TYPE_ADJUST)!=-1){this.adjustCount(b);}else if(a.indexOf(CounterDisplay.EVENT_TYPE_UPDATE)!=-1){this.setCount(b);}else return;return;}});
function MenubarMessageController(a,b){}copy_properties(MenubarMessageController,{ensureInitialized:function(a,b,c){if(MenubarMessageController.initialized||!ge(b))return false;var d=new MenubarMessageController(a,b);MenubarMessageController.instance=d;d.ensureInitialized(a,b,c);MenubarMessageController.initialized=true;}});copy_properties(MenubarMessageController.prototype,{ensureInitialized:function(a,b,c,d){this.menu=ge(b);this.fetchOnHover=d;var e=[CounterDisplay.EVENT_TYPE_ADJUST+'/messages_unread',CounterDisplay.EVENT_TYPE_UPDATE+'/messages_unread'];Arbiter.subscribe(e,this.onCounterUpdate.bind(this),Arbiter.SUBSCRIBE_NEW);Arbiter.subscribe(PresenceMessage.getArbiterMessageType('messages_seen'),function(){Arbiter.inform('jewel/count-updated',{jewel:'messages',count:0},Arbiter.BEHAVIOR_STATE);});this._dirty=c;if(d)this.mouseOverListener=Event.listen($(a),'mouseover',this.doRefetch.bind(this));},doRefetch:function(){if(this._dirty){this._dirty=false;this._fetch();}},_fetch:function(){},onFetchComplete:function(a){if(this.menu)DOM.setContent(this.menu,HTML(a.payload));},onCounterUpdate:function(){this._dirty=true;},markSeen:function(a){new AsyncSignal('/ajax/gigaboxx/endpoint/UpdateLastSeenTime.php',{folder:a}).send();}});
function FriendBrowserCheckboxController(){}copy_properties(FriendBrowserCheckboxController,{instances:{},getInstance:function(a){return this.instances[a];}});FriendBrowserCheckboxController.prototype={init:function(a,b){FriendBrowserCheckboxController.instances[a]=this;this._id=a;this._form=b;this._contentGrid=DOM.find(b,'.friendBrowserCheckboxContentGrid');this._loadingIndicator=DOM.find(b,'.friendBrowsingCheckboxContentLoadingIndicator');this._checkboxResults=DOM.find(b,'.friendBrowserCheckboxResults');this._contentPager=DOM.find(b,'.friendBrowserCheckboxContentPager');this.numGetNewRequests=0;this.queuedRequests={};},addTypeahead:function(a,b){a.subscribe('select',this.onHubSelect.bind(this,a,b));},onHubSelect:function(a,b,event,c){if(!((event=='select')&&c.selected))return;var d=this.buildNewCheckbox(b,c.selected.text,c.selected.uid),e=DOM.find(this._form,'.checkboxes_'+b);DOM.appendContent(e.firstChild,d);var f=DOM.scry(a.getElement(),'input[type="button"]');if(f&&f[0])f[0].click();this.getNew(true);},buildNewCheckbox:function(a,b,c){var d=a+'_ids_'+c,e=a+'_ids[]',f=$N('input',{id:d,type:'checkbox',value:c,name:e,checked:true});Event.listen(f,'click',bind(this,'getNew',false));var g=$N('td',null,f);CSS.addClass(g,'vTop');CSS.addClass(g,'hLeft');var h=$N('label',null,b),i=$N('td',null,h);CSS.addClass(i,'vMid');CSS.addClass(i,'hLeft');var j=$N('tr');j.appendChild(g);j.appendChild(i);return j;},navAddTypeahead:function(a,b){a.subscribe('select',this.navOnHubSelect.bind(this,a,b));a.subscribe('blur',this.navHideTypeahead.bind(this,b));},navOnHubSelect:function(a,b,event,c){if(!((event=='select')&&c.selected))return;if(!ge(b+'_ids_'+c.selected.uid)){var d=$(b+'_ids_0'),e=d.cloneNode(true);e.id=b+'_ids_'+c.selected.uid;DOM.find(e,'a').onclick=bind(this,function(){this.setTypeAndFilterId(b,c.selected.uid).getNew(true);});DOM.setContent(DOM.find(e,'.linkWrap'),c.selected.text);DOM.insertBefore(e,d);CSS.show(e);}var f=DOM.scry(a.getElement(),'input[type="button"]');if(f&&f[0])f[0].click();this.navHideTypeahead(b);this.setTypeAndFilterId(b,c.selected.uid).getNew(true);},navHideTypeahead:function(a){CSS.hide($(a+'_ids_typeahead'));CSS.show($(a+'_ids_0'));},navShowTypeahead:function(a){CSS.hide($(a+'_ids_0'));typeahead=$(a+'_ids_typeahead');CSS.show(typeahead);DOM.find(typeahead,'.inputtext').focus();},showMore:function(){var a=DOM.scry(this._contentPager,'.friendBrowserMorePager')[0];if(!a)return false;if(CSS.hasClass(a,'async_saving'))return false;var b=this.numGetNewRequests,c=Form.serialize(this._form);c.show_more=true;var d=new AsyncRequest().setURI('/ajax/growth/friend_browser/checkbox.php').setData(c).setHandler(bind(this,function(e){this.showMoreHandler(e,b);})).setStatusElement(a).send();},showMoreHandler:function(a,b){if(b==this.numGetNewRequests){var c=a.payload;DOM.appendContent(this._contentGrid,c.results);this.updatePagerAndExtraData(c.pager,c.extra_data);}},getNew:function(a){this.numGetNewRequests++;var b=this.numGetNewRequests;CSS.addClass(this._checkboxResults,'friendBrowserCheckboxContentOnload');if(ge('friendBrowserCI'))CSS.addClass($('friendBrowserCI'),'friendBrowserCheckboxContentOnload');CSS.show(this._loadingIndicator);var c=Form.serialize(this._form);c.used_typeahead=a;new AsyncRequest().setURI('/ajax/growth/friend_browser/checkbox.php').setData(c).setHandler(bind(this,function(d){this.getNewHandler(d,b);})).send();},getNewHandler:function(a,b){if(b==this.numGetNewRequests){var c=a.payload;DOM.setContent(this._contentGrid,c.results);CSS.removeClass(this._checkboxResults,'friendBrowserCheckboxContentOnload');if(ge('friendBrowserCI'))CSS.hide($('friendBrowserCI'));CSS.hide(this._loadingIndicator);this.updatePagerAndExtraData(c.pager,c.extra_data);}},updatePagerAndExtraData:function(a,b){DOM.setContent(this._contentPager,a);this.setupOnVisible();DOM.replace(this._form.elements.extra_data,b);},setupOnVisible:function(){var a=DOM.scry(this._contentPager,'.friendBrowserMorePager')[0];if(a&&this._id!='jewel'){this._onVisible&&this._onVisible.remove();this._onVisible=new OnVisible(a,bind(this,'showMore'),false,1000);}},makeFriendRequest:function(a,b,c,d,e){var f=Form.serialize(this._form);f.friend_id=b;if(c)f.countdown_complete=c;if(d)f.cancel=d;if(e)f.dialog_success=e;var g=new AsyncRequest();g.setURI('/ajax/growth/friend_browser/friend.php').setData(f).setRelativeTo(a).send();},queueRequest:function(a,b){this.queuedRequests[b]=true;setTimeout(bind(this,function(){this.sendQueuedRequest(a,b);}),5000);},sendQueuedRequest:function(a,b){if(this.queuedRequests[b]){this.queuedRequests[b]=false;var c=$(a),d=DOM.find(c,'^.friendBrowserUnit');CSS.removeClass(d,'friendBrowserRequesting');CSS.addClass(d,'friendBrowserRequested');this.makeFriendRequest(c,b,true);}},cancelQueuedRequest:function(a,b){this.queuedRequests[b]=false;this.makeFriendRequest(a,b,false,true);},showConfirmationDialog:function(a,b,c,d,e){var f=this;ConnectDialog.newInstance(b,c,function(){f.makeFriendRequest(a,b,false,false,true);return false;},null,false,null,0,'','',d,e).show();return false;},initRightHandColumn:function(){new StickyController($('friendBrowserRightColumn'),50).start();},initFriendCollector:function(){var a=this.reloadFriendCollector.bind(this);Arbiter.subscribe(FriendRequestMessage.SENT,a);},reloadFriendCollector:function(a,b){UIPagelet.loadFromEndpoint('RecentlyRequestedPagelet','recently_requested_pagelet',{last_requested_uid:b.uid},{usePipe:true});},setTypeAndFilterId:function(a,b){DOM.find(this._form,'#selected_type').value=a;DOM.find(this._form,'#selected_filter_id').value=b;CSS.removeClass(DOM.find($('sideNav'),'.selectedItem'),'selectedItem');if(a&&b){CSS.addClass($(a+'_ids_'+b),'selectedItem');}else CSS.addClass(DOM.find($('sideNav'),'#find_friends'),'selectedItem');$('headerArea').scrollIntoView(false);return this;}};
function TickerRightHideController(){}TickerRightHideController._markAsClosedHelper=function(a){var b=ge('pagelet_reminders');if(b){var c=DOM.scry(b,'div.tickerToggleWrapper')[0];if(c)CSS.conditionClass(c,'displayedTickerToggleWrapper',a);}var d=ge('pagelet_rhc_ticker');if(d){var e=DOM.scry(d,'div.tickerToggleWrapper')[0];if(e)CSS.conditionClass(e,"displayedTickerToggleWrapper",!a);CSS.conditionClass(d,"hidden_rhc_ticker",a);}};TickerRightHideController.markAsClosed=function(){TickerRightHideController._markAsClosedHelper(true);};TickerRightHideController.markAsUnclosed=function(){TickerRightHideController._markAsClosedHelper(false);};
__e("UIIntentionalStreamMessage",[],function(a,b,c,d,e,f){var g={SET_AUTO_INSERT:'UIIntentionalStream/setAutoInsert',UPDATE_STREAM:'UIIntentionalStreamRefresh/updateStream',REFRESH_STREAM:'UIIntentionalStreamRefresh/refreshStream',UPDATE_AUTOREFRESH_CONFIG:'UIIntentionalStream/updateAutoRefreshConfig',UPDATE_HTML_CONTENT:'UIIntentionalStream/updateHtmlContent',UPDATE_LAST_REFRESH_TIME:'UIIntentionalStream/updateLastRefreshTime',INSERT_STORIES:'UIIntentionalStream/updateLastRefreshTime'};e.exports=g;});
__e("legacy:UIIntentionalStream-message",["UIIntentionalStreamMessage"],function(a,b,c,d){a.UIIntentionalStreamMessage=b('UIIntentionalStreamMessage');},3);
function HomeAdFirstRightColumnController(){}HomeAdFirstRightColumnController.prototype={init:function(a){copy_properties(this,{_enableSidebar:a.enableSidebar,_tickerHeightOffset:200,contentCol:$('contentCol'),blueBar:$('blueBar'),_tickerMaxHeight:(a.tickerMaxHeight||500),_listeners:[],_subscriptions:[]});this._topOffset=0;this.PADDING_TICKER_TO_TOP=5;this.PADDING_RHC_TO_BOTTOM=60;this._sidebarIsHidden=true;this._listeners.push(Event.listen(window,'resize',this.handleResize.bind(this)));this._blueBarHeight=Vector2.getElementDimensions(this.blueBar).y;this.reloadRightCol();this._initSubscriptions();onunloadRegister(this.cleanup.bind(this));this._listeners.push(Event.listen(window,'scroll',this._handleScroll.bind(this)));if(!CSS.hasClass(document.documentElement,'sidebarMode')){this._onSidebarHide();}else if(this._enableSidebar)this._onSidebarShow();this.handleResize();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('Ticker/storiesInserted',this.handleResize.bind(this)),Arbiter.subscribe('concierge/load',this.handleResize.bind(this)),Arbiter.subscribe(UIIntentionalStreamMessage.INSERT_STORIES,this.handleResize.bind(this))];if(this._enableSidebar){this._subscriptions.push(Arbiter.subscribe('sidebar/hide',this._onSidebarHide.bind(this)));this._subscriptions.push(Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this)));}},_onNavHandler:function(a,b){var c=b.params.key;if(c!='lf'&&c!='h')this.cleanup();},reloadRightCol:function(){this.fixedScrollingContainer=ge('fixed_scrolling_container');this.fixedScrollingWrapper=DOM.scry(this.fixedScrollingContainer,'.fixed_scrolling_wrapper')[0];this.tickerPagelet=ge('pagelet_rhc_ticker');if(!this.tickerPagelet)return false;this.tickerContainer=DOM.scry(this.tickerPagelet,'.ticker_container')[0];this.tickerStream=DOM.scry(this.tickerPagelet,'.ticker_stream')[0];return this.tickerContainer&&this.tickerStream;},cleanup:function(){this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions=[];this._listeners.each(function(a){a.remove();});this._listeners=[];},_handleScroll:function(){if(!this._sidebarIsHidden||!this.tickerStream)return;this._topOffset=this.PADDING_TICKER_TO_TOP+this._blueBarHeight;var a=CSS.hasClass(document.documentElement,'tinyViewport'),b=!a;if(b){var c=Vector2.getElementPosition(this.fixedScrollingContainer,'viewport');if(!c||c.y>=this._topOffset)b=false;}if(b!==CSS.hasClass(this.fixedScrollingWrapper,'fixed_elem'))this._setFixedRightCol(b);},_setFixedRightCol:function(a){var b=a?this._topOffset+'px':'';CSS.setStyle(this.fixedScrollingWrapper,'top',b);CSS.conditionClass(this.fixedScrollingWrapper,'fixed_elem',a);var c=a?'Ticker/fixed':'Ticker/unfixed';Arbiter.inform(c);},handleResize:function(){if(!this._sidebarIsHidden||!this.tickerStream||CSS.hasClass(document.documentElement,'tinyViewport'))return;this._handleScroll();var a=Vector2.getViewportDimensions().y,b=Vector2.getElementDimensions(this.fixedScrollingWrapper).y-Vector2.getElementDimensions(this.tickerContainer).y,c=a-this._topOffset-b-this.PADDING_RHC_TO_BOTTOM,d=Vector2.getElementDimensions(this.tickerStream).y,e=Math.min(c,d,this._tickerMaxHeight);CSS.setStyle(this.tickerContainer,'height',e+'px');},_onSidebarHide:function(){this._sidebarIsHidden=true;this.reloadRightCol();var a=function(){if(this.reloadRightCol())this.handleResize();};this.tickerPagelet&&TickerController.show(this.tickerPagelet,a.bind(this));},_onSidebarShow:function(){this._sidebarIsHidden=false;this.reloadRightCol();this._setFixedRightCol(false);this.tickerPagelet&&TickerController.hide(this.tickerPagelet);}};
function SidebarTicker(){}SidebarTicker.prototype={ALMOST_ZERO:1e-07,init:function(){this._ticker=$('pagelet_ticker');this._initSubscriptions();CSS.addClass(document.documentElement,'ticker');if(CSS.hasClass(document.documentElement,'sidebarMode'))this._onSidebarShow();return this;},initResizeBehavior:function(a){var b=this._ticker,c=b.parentNode,d=this._saveResizedState.bind(this),e=this.ALMOST_ZERO,f,g,h,i=function(l,event){f=event.clientY;g=b.offsetHeight;h=c.offsetHeight;},j=function(l,event){var m=g+(event.clientY-f),n=100-(((h-m)/h)*100);n=Math.max(e,Math.min(90,n));b.style.height=n+'%';if(l=='end'){d(n);Arbiter.inform('Ticker/resized');}window.ChatSidebar&&ChatSidebar.resize();},k=new SimpleDrag(a);k.subscribe('start',i);k.subscribe(['update','end'],j);},_saveResizedState:function(a){new AsyncRequest('/ajax/feed/ticker/resize').setData({height:''+a}).setMethod('POST').send();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this))];},_onSidebarShow:function(){TickerController.show(this._ticker);}};
function HomeTickerFirstRightColumnController(){}HomeTickerFirstRightColumnController.prototype={_isFixed:false,_forcedStatic:false,_PADDING_RHC_TO_BOTTOM:75,_PADDING_RHC_TO_BOTTOM_SHORT:50,_MAX_FIXED_ADS:3,_refreshOn:false,_fixAdsOnScroll:false,init:function(a){copy_properties(this,{_adsRefreshInterval:a.adsRefreshInterval,_adsRefreshDelay:a.adsRefreshDelay,_adsRefreshOnmove:a.adsRefreshOnmove,_enableSidebar:a.enableSidebar,_fixAdsOnScroll:a.fixAdsOnScroll,contentCol:$('contentCol'),blueBar:$('blueBar'),_tickerMaxHeight:(a.tickerMaxHeight||425),_tickerMinHeight:(a.tickerMinHeight||225),_tickerAbsMinHeight:(a.tickerAbsMinHeight||120),_listeners:[],_subscriptions:[]});this._listeners.push(Event.listen(window,'resize',throttle(this.handleResize.bind(this))));this.blueBarHeight=Vector2.getElementDimensions(this.blueBar).y;this.reloadRightCol();this._initSubscriptions();onleaveRegister(this.cleanup.bind(this));this._listeners.push(Event.listen(window,'scroll',throttle(this._handleScroll.bind(this))));if(this._adsRefreshOnmove)this._listeners.push(Event.listen(window,'mousemove',throttle(this._handleMove.bind(this))));this._lastAdLoadTime=Date.now();this._debounceReloadAdsIfNeeded=debounce(this._reloadAdsIfNeeded.bind(this),this._adsRefreshDelay,true);if(!CSS.hasClass(document.documentElement,'sidebarMode')){this._onSidebarHide();}else if(this._enableSidebar)this._onSidebarShow();this._handleAdsLoad();},_handleAdsLoad:function(){var a=this.handleResize.bind(this);function b(){a.defer();}var c=DOM.scry(this.egoPagelet,'img.img');c.each(function(d){if(!d.complete)Event.listen(d,{load:b,error:b,abort:b});});b();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('page_transition',this.cleanup.bind(this)),Arbiter.subscribe('Ticker/storiesInserted',this.handleResize.bind(this)),Arbiter.subscribe('concierge/load',this.handleResize.bind(this)),Arbiter.subscribe(UIIntentionalStreamMessage.INSERT_STORIES,this.handleResize.bind(this))];if(this._enableSidebar){this._subscriptions.push(Arbiter.subscribe('sidebar/hide',this._onSidebarHide.bind(this)));this._subscriptions.push(Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this)));}},reloadRightCol:function(){this.rightColumn=DOM.scry(ge('rightCol'),'div.home_right_column')[0];this.rightColumnWrapper=DOM.find(this.rightColumn,'div.rightColumnWrapper');this.egoPagelet=ge('pagelet_ego_pane_w');if(!this.egoPagelet)this.egoPagelet=ge('pagelet_ego_pane_m');this._refreshOn=!this.containsPremium();this.tickerPagelet=ge('pagelet_rhc_ticker');if(!this.tickerPagelet)return false;this.tickerContainer=DOM.scry(this.tickerPagelet,'.ticker_container')[0];this.tickerStream=DOM.scry(this.tickerPagelet,'.ticker_stream')[0];return this.tickerContainer&&this.tickerStream;},containsPremium:function(){if(this.egoPagelet){var a=DOM.scry(this.egoPagelet,'.fbAdUnit');for(var b=0;b<a.length;b++){var c=JSON.parse(a[b].getAttribute('data-ad')).segment;if(c==='premium')return true;}}return false;},cleanup:function(a,b){if(a==='page_transition'&&b&&b.uri){var c=b.uri;if(c.path==='/photo.php'&&c.query_s.indexOf('theater')>=0){this._inSnowbox=true;return;}if(this._inSnowbox&&c.path==='/'){this._inSnowbox=false;return;}}this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions=[];this._listeners.each(function(d){d.remove();});this._listeners=[];this._debounceReloadAdsIfNeeded.reset();},_calculateDistanceFromTopOfRHCToTopOfAds:function(){if(this.forceFixingEvaluation||!this._isFixed)this.distanceFromTopOfRHCToTopOfAds=Vector2.getElementPosition(this.egoPagelet,'viewport').y-Vector2.getElementPosition(this.rightColumnWrapper,'viewport').y;},_handleScroll:function(){this._debounceReloadAdsIfNeeded();this._calculateDistanceFromTopOfRHCToTopOfAds();this._topOffset=this.blueBarHeight+Vector2.getElementPosition(this.blueBar,'viewport').y;var a=this._topOffset,b=Vector2.getElementPosition(this.rightColumn,'viewport').y;if(this._forcedStatic||!this.tickerStream){if(this._fixAdsOnScroll&&this.adsStickPoint!==null){var c=b+this.distanceFromTopOfRHCToTopOfAds,d=c<=a-this.adsStickPoint;if(this.forceFixingEvaluation||d!==this._isFixed){this.forceFixingEvaluation=false;var e=a-this.adsStickPoint-this.distanceFromTopOfRHCToTopOfAds;this._setFixed(d,e);}}return;}var f=b<=a;if(f!==this._isFixed)this._setFixed(f);},_handleMove:function(){this._debounceReloadAdsIfNeeded();},_reloadAdsIfNeeded:function(){var a=Date.now();if(this._refreshOn&&this._adsRefreshInterval>0&&a-this._lastAdLoadTime>=this._adsRefreshInterval)this._reloadAds();},_reloadAds:function(){this._lastAdLoadTime=Date.now();UIPagelet.loadFromEndpoint('WebEgoPane',this.egoPagelet,{pid:27,data:{organic_only:false,ads_only:false,is_refresh:true}},{crossPage:false,handler:this._handleAdsLoad.bind(this)});},_recalculateAndReposition:function(){this.forceFixingEvaluation=true;this._calculateDistanceFromTopOfRHCToTopOfAds();this._recalculateFixingPosition();this._handleScroll();},_recalculateFixingPosition:function(){if(!this._fixAdsOnScroll)return;var a=Vector2.getViewportDimensions().y-this.blueBarHeight-this._PADDING_RHC_TO_BOTTOM_SHORT,b=Vector2.getElementDimensions(this.rightColumnWrapper).y;if(b<=a){this.adsStickPoint=0-this.distanceFromTopOfRHCToTopOfAds;return;}var c=b-this.distanceFromTopOfRHCToTopOfAds,d=DOM.scry(this.egoPagelet,'div.egoOrganicColumn')[0];if(c<=a&&d){this.adsStickPoint=0;}else{var e=DOM.scry(this.egoPagelet,'div.ego_unit').reverse(),f=Math.min(e.length,this._MAX_FIXED_ADS),g=null;for(var h=0;h<f;h++){var i=e[h],j=Vector2.getElementPosition(i,'viewport').y-Vector2.getElementPosition(this.rightColumnWrapper,'viewport').y,k=Vector2.getElementDimensions(this.rightColumnWrapper).y-j;if(k>a){if(h>0)g=e[h-1];break;}if(h==f-1)g=i;}if(g==null){this.adsStickPoint=null;}else this.adsStickPoint=Vector2.getElementPosition(g,'viewport').y-Vector2.getElementPosition(this.egoPagelet,'viewport').y;}},_setFixed:function(a,b){this._isFixed=a;b=b||this._topOffset;var c=a?b+'px':'';CSS.setStyle(this.rightColumnWrapper,'top',c);CSS.conditionClass(this.rightColumnWrapper,'fixed_elem',a);var d=DOM.scry(this.rightColumnWrapper,'div.displayedTickerToggleWrapper')[0];d&&CSS.conditionClass(d,'toggleWrapperWithoutMargin',this._fixAdsOnScroll&&a&&!this.tickerStream);var e=a?'Ticker/fixed':'Ticker/unfixed';Arbiter.inform(e);},handleResize:function(){if(!this._sidebarIsHidden||!this.tickerStream||CSS.hasClass(document.documentElement,'tinyViewport')){this._recalculateAndReposition();return;}this._handleScroll();var a=Vector2.getViewportDimensions().y,b=61,c=Vector2.getElementDimensions(this.rightColumnWrapper).y-Vector2.getElementDimensions(this.tickerContainer).y,d=Vector2.getElementDimensions(this.tickerStream).y,e=a-c-this._PADDING_RHC_TO_BOTTOM-this._topOffset-b,f=this._tickerAbsMinHeight,g=this._tickerMinHeight;this._forcedStatic=false;if(e<f){this._forcedStatic=true;this._setFixed(false);e=f;}else if(e<g)if(e>(g-b)){e=g;}else e+=b;var h=Math.min(e,d,this._tickerMaxHeight);CSS.setStyle(this.tickerContainer,'height',h+'px');},_onSidebarHide:function(){this._sidebarIsHidden=true;this.reloadRightCol();var a=function(){if(this.reloadRightCol()){this._forcedStatic=false;this._handleScroll();this.handleResize();}};this.tickerPagelet&&TickerController.show(this.tickerPagelet,a.bind(this));},_onSidebarShow:function(){this._sidebarIsHidden=false;this.reloadRightCol();if(this._fixAdsOnScroll){this._recalculateAndReposition();}else{this._forcedStatic=true;this._setFixed(false);}this.tickerPagelet&&TickerController.hide(this.tickerPagelet);}};
function FansJewel(){}FansJewel.prototype={init:function(a){this.jewel=a;this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));},_markSeenCallback:function(a,b){new AsyncRequest('/ajax/pages/fans_seen.php').setMethod('POST').send();}};
__e("JewelX",["event-extensions","Arbiter","ArbiterMixin","Class","css","dom","HTML","Toggler","copyProperties","userAction"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Class'),j=b('css'),k=b('dom'),l=b('HTML'),m=b('Toggler'),n=b('copyProperties'),o=b('userAction'),p=function(){};n(p,{_instancesByName:{},_resizeListener:null});i.mixin(p,h,{init:function(q,r){this.name=r.name;this.root=q;this.countNew=0;this.initialCount=0;this.disableMarkAllRead=r.disableMarkAllRead||false;p._instancesByName[this.name]=this;m.listen(['show','hide'],this.root,function(s){var t=s==='show';t&&this._logFirstClick();if(!this.disableMarkAllRead){this.hasNew()&&this.markSeen();this.reset();}this.inform(t?'opened':'closed');g.inform(t?'layer_shown':'layer_hidden',{type:'Jewel'});}.bind(this));g.subscribe('jewel/count-updated',function(s,t){t.jewel==this.name&&this.update(t);}.bind(this));g.subscribe('jewel/count-initial',function(s,t){t.jewel==this.name&&this.setInitial(t);}.bind(this));g.subscribe('jewel/reset',function(s,t){t.jewel==this.name&&this.reset();}.bind(this));p._resizeListener=p._resizeListener||(function(){var s=null;return Event.listen(window,'resize',function(event){clearTimeout(s);s=g.inform.bind(g,'jewel/resize',event).defer(100,false);});})();},getRoot:function(){return this.root;},hasNew:function(){return j.hasClass(this.root,'hasNew');},isOpen:function(){return j.hasClass(this.root,'openToggler');},reset:function(){j.removeClass(this.root,'hasNew');},setContent:function(q){var r=k.find(this.root,'ul.jewelItemList');k.setContent(r,l(q));},update:function(q){this.countNew=q.count;var r=k.find(this.root,'span.jewelCount span');k.setContent(r,this.countNew);var s=isNaN(this.countNew)||this.countNew>0;j.conditionClass(this.root,'hasNew',s);this.inform('updated',q);},setInitial:function(q){this.initialCount=q;},markSeen:function(){g.inform('jewel/count-updated',{jewel:this.name,count:0},g.BEHAVIOR_STATE);this.inform('marked-seen');},_logFirstClick:function(){this._logFirstClick=bagofholding;o('jewel_click',null,null,'FORCE',{gt:{count:this.countNew,initial:this.initialCount,jewel:this.name}});}});e.exports=p;});
__e("legacy:JewelX",["JewelX"],function(a,b,c,d){a.JewelX=b('JewelX');},3);
__e("MessagingEvents",["array-extensions","Arbiter","copyProperties","isEmpty"],function(a,b,c,d,e,f){b('array-extensions');var g=b('Arbiter'),h=b('copyProperties'),i=b('isEmpty'),j={},k=new g();function l(m){if(!i(j))return;for(var n in m)k.inform('count/'+n,m[n]);}k.subscribe('mark-as-read',function(m,n){(n.tids||n.chat_ids||[]).forEach(function(o){o=''+o;if(!(o in j)){j[o]=true;var p=function(){k.unsubscribe(q);clearTimeout(r);delete j[o];},q=k.subscribe('read',function(s,t){if((t.tids||[]).contains(o)||(t.chat_ids||[]).contains(o))p();}),r=p.defer(60000);}});});g.subscribe('presence/message:messaging',function(m,n){var o=h({},n.obj),event=o.event||'';delete o.type;delete o.event;k.inform(event,o);if('unread_counts' in o){var p=o.unread_counts;l({unread:p.inbox,other_unseen:p.other});}});g.subscribe('presence/message:inbox',function(m,n){var o=h(n.obj);delete o.type;l(o);});a.MessagingEvents=e.exports=k;},3);
function MessagesJewel(){}MessagesJewel.prototype={init:function(a,b){this.jewel=a;this.jewelFlyoutCase=ge('jewelFlyoutContainer');this.jewelFlyout=ge('fbMessagesFlyout');this.newCountSpan=ge('newMessageCount');this.folder=b;var c=ge('messagesMarkReadButton');if(c)Event.listen(c,'click',this._markRead.shield(this,true));this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));this.jewel.subscribe('updated',this._updateCount.bind(this));this.jewel.subscribe('opened',this._overflowHandler.bind(this));Arbiter.subscribe('jewel/resize',this._overflowHandler.bind(this));Arbiter.subscribe('jewel/messages/fetched',this._overflowHandler.bind(this));MessagingEvents.subscribe('count/unread',this._updateInboxUnreadCount.bind(this));MessagingEvents.subscribe('count/unseen',this._updateInboxUnseenCount.bind(this));MessagingEvents.subscribe('count/other_unseen',this._updateInboxOtherUnseenCount.bind(this));},_markRead:function(a,b){Arbiter.inform('jewel/count-updated',{jewel:'messages',count:0});},_markSeenCallback:function(a,b){MenubarMessageController.instance.markSeen(this.folder);},_updateCount:function(a,b){this.countNew=b.count;CSS.conditionClass(this.jewelFlyout,'beeperUnread',this.countNew>0);CSS.conditionClass(this.jewelFlyoutCase,'showMessages',this.countNew>0);if(this.newCountSpan){var c=this.countNew==1?tx._("{num} NEW MESSAGE",{num:this.countNew}):tx._("{num} NEW MESSAGES",{num:this.countNew});DOM.setContent(this.newCountSpan,c);}},_overflowHandler:function(){window.Unibeeper&&Unibeeper.hideOverflow(DOM.scry($('fbMessagesItemList'),'li'),DOM.find(this.jewelFlyout,'.jewelFooter'));},_updateInboxOtherUnseenCount:function(a,b){CounterDisplay.setCount('other_unseen',b);},_updateInboxUnreadCount:function(a,b){CounterDisplay.setCount('messages_unread',b);},_updateInboxUnseenCount:function(a,b){CounterDisplay.setCount('messages_unseen',b);Arbiter.inform('jewel/count-updated',{jewel:'messages',count:b},Arbiter.BEHAVIOR_STATE);}};
function RequestsJewel(){}RequestsJewel.prototype={init:function(a,b,c){this.countNew=0;this.jewel=a;this.jewelFlyoutCase=ge('jewelFlyoutContainer');this.jewelFlyout=ge('fbRequestsFlyout');this.newCountSpan=ge('newRequestCount');this.folder=b;this.doNewMarkRead=c;this._requestList={};this._requestCount=0;var d=ge('requestsMarkReadButton');if(d)Event.listen(d,'click',this._markRead.shield(this));this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));this.jewel.subscribe('closed',this._clearNewItems.shield(this));this.jewel.subscribe('updated',this._updateCount.bind(this));this.jewel.subscribe('opened',this._openHandler.bind(this));Arbiter.subscribe('jewel/resize',this._overflowHandler.bind(this));window.Unibeeper&&Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/handled'),this._removeRequest.bind(this));LinkController.registerHandler(this._handleLink.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/add'),this._addRequest.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/remove_old'),this._removeOldRequest.bind(this));Event.listen(this.jewelFlyout,'submit',function(f){var g=Parent.byClass(f.getTarget(),'objectListItem');if(g){CSS.removeClass(g,'jewelItemNew');CSS.addClass(g,'jewelItemResponded');}}.bind(this));var e=DOM.scry(this.jewelFlyout,'.uiScrollableAreaWrap')[0];if(e){this._scrollableWrap=e;this._lastLinkPosition=0;this._scrollListener=Event.listen(e,'scroll',this._handleScroll.bind(this),Event.Priority._BUBBLE);}return this;},fromDom:function(){DOM.scry(this.jewelFlyout,'.jewelItemList li.objectListItem').each(function(a){var b=a.getAttribute('id'),c=b&&parseInt(this._parseID(b).requester,10);if(c&&!isNaN(c)){this._requestList[c]=b;++this._requestCount;}}.bind(this));this._conditionShowEmptyMessage();},_parseID:function(a){var b=a.match(/^(\d+)_(\d+)/);return (b)?{requester:b[1],type:b[2]}:undefined;},_handleLink:function(a,event){var b=Parent.byClass(a,'jewelItemNew');if(b&&Parent.byClass(b,'fbRequestList')&&Parent.byClass(b,'beeperEnabled')){var c=this._parseID(b.id);c&&this._markSeenCallback(c.requester,c.type);Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});CSS.removeClass(b,'jewelItemNew');}return true;},_handleScroll:function(){var a=DOM.scry(this._scrollableWrap,'.uiMorePager')[0];if(a){var b=Vector2.getElementPosition(a,'viewport').y;if(b>0)CSS.addClass(Parent.byClass(this._scrollableWrap,'uiScrollableArea'),'contentAfter');var c=DOM.find(a,'a');if(!c)return;var d=Vector2.getElementPosition(c,'viewport').y;if(d==this._lastLinkPosition)return;var e=Vector2.getElementPosition(this._scrollableWrap,'viewport').y+Vector2.getElementDimensions(this._scrollableWrap).y;if(d-300<e&&d>0){this._lastLinkPosition=d;var f=c.getAttribute('ajaxify');if(f){new AsyncRequest(f).setRelativeTo(c).setStatusElement(Parent.byClass(c,'stat_elem')).send();}else FriendBrowserCheckboxController.getInstance('jewel').showMore();}}},_addRequest:function(a,b){if(!b||this._requestList[b.obj.from])return;var c=DOM.scry(this.jewelFlyout,'.fbRequestList .uiList')[0];if(!c)return;DOM.prependContent(c,b.obj.markup);var d={jewel:'requests',count:++this.countNew};Arbiter.inform('jewel/count-updated',d);this._requestList[b.obj.from]=elem.id;++this._requestCount;this._conditionShowEmptyMessage();},_removeOldRequest:function(a,b){if(!b)return;var c=this._requestList[b.obj.from],d=c&&ge(c);if(d){CSS.hasClass(d,'jewelItemNew')&&Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});if(!CSS.hasClass(d,'jewelItemResponded')){DOM.remove(d);delete this._requestList[c];--this._requestCount;this._conditionShowEmptyMessage();}}},_markRead:function(){this.jewel.markSeen();this._clearNewItems();},_markSeenCallback:function(a,b){new AsyncSignal('/ajax/gigaboxx/endpoint/UpdateLastSeenTime.php',{folder:this.folder}).send();var c=typeof a!='undefined'&&typeof b!='undefined'?{requester:a,type:b}:{};this.doNewMarkRead&&new AsyncSignal('/ajax/requests/mark_read/',c).send();},_removeRequest:function(a,b){var c=b.obj.item_id;if(c){var d=ge(c),e=d&&CSS.hasClass(d,'jewelItemNew');d?DOM.remove(d):false;e&&Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});}},_clearNewItems:function(a,b){DOM.scry(this.jewel.root,'li.jewelItemNew').each(function(c){CSS.removeClass(c,'jewelItemNew');});},_updateCount:function(a,b){this.countNew=b.count;CSS.conditionClass(this.jewelFlyout,'beeperUnread',this.countNew>0);CSS.conditionClass(this.jewelFlyoutCase,'showRequests',this.countNew>0);if(this.newCountSpan){var c=this.countNew==1?tx._("{num} NEW REQUEST",{num:this.countNew}):tx._("{num} NEW REQUESTS",{num:this.countNew});DOM.setContent(this.newCountSpan,c);}},_conditionShowEmptyMessage:function(){DOM.scry(this.jewelFlyout,'li.empty').each(function(a){CSS.conditionShow(a,this._requestCount<=0);}.bind(this));},_openHandler:function(){var a=DOM.scry(this.jewelFlyout,'.uiScrollableArea')[0];a&&ScrollableArea.poke(a);this._overflowHandler();},_overflowHandler:function(){window.Unibeeper&&Unibeeper.hideOverflow(DOM.scry($('fbRequestsList'),'li'),DOM.find(this.jewelFlyout,'.jewelFooter'));}};
__e("IframeShim",["dom","Rect"],function(a,b,c,d,e,f){var g=b("dom"),h=b("Rect"),i=g.$N;function j(k){this._element=k;this._shim=null;}j.prototype={show:function(){this._shim||this._buildShim();return this._updatePosition();},hide:function(){if(this._shim){g.remove(this._shim);this._shim=null;}return this;},_buildShim:function(){this._shim=i('iframe',{frameBorder:0,scrolling:'no',src:'about:blank',style:{position:'absolute',filter:'progid:DXImageTransform.Microsoft.Alpha(style=0,opacity=0)'}});g.prependContent(g.getDocumentBodyElement(),this._shim);},_updatePosition:function(){var k=new h(this._element);k.getPositionVector().setElementPosition(this._shim);k.getDimensionVector().setElementDimensions(this._shim);}};e.exports=j;});
__e("legacy:iframe-shim",["IframeShim"],function(a,b,c,d){a.IframeShim=b('IframeShim');},3);
function DoublyLinkedListMap(){this._head=null;this._tail=null;this._nodes={};}DoublyLinkedListMap.prototype={get:function(a){return this._nodes[a]?this._nodes[a].data:null;},_insert:function(a,b,c,d){c&&!this._nodes[c]&&(c=null);var e=(c&&this._nodes[c])||(d?this._head:this._tail),f={data:b,key:a,next:null,prev:null};if(e){this.remove(a);if(d){f.prev=e.prev;e.prev&&(e.prev.next=f);e.prev=f;f.next=e;}else{f.next=e.next;e.next&&(e.next.prev=f);e.next=f;f.prev=e;}}f.prev===null&&(this._head=f);f.next===null&&(this._tail=f);this._nodes[a]=f;return this;},insertBefore:function(a,b,c){return this._insert(a,b,c,true);},insertAfter:function(a,b,c){return this._insert(a,b,c,false);},prepend:function(a,b){return this.insertBefore(a,b,this._head&&this._head.key);},append:function(a,b){return this.insertAfter(a,b,this._tail&&this._tail.key);},remove:function(a){var b=this._nodes[a];if(b){var c=b.next,d=b.prev;c&&(c.prev=d);d&&(d.next=c);this._head===b&&(this._head=c);this._tail===b&&(this._tail=d);delete this._nodes[a];}return this;},find:function(a){for(var b=this._head;b;b=b.next)if(a(b.data))return b.key;return null;},reduce:function(a,b){for(var c=this._head;c;c=c.next)b=a(c.data,b);return b;},exists:function(a){return !!this._nodes[a];},isEmpty:function(){return !this._head;}};
function startMessagingNavCountUpdater(a,b){var c=FutureSideNav.getInstance().getNodeForKey('inbox');if(!c)return;if(!b)var d=DOM.scry(c,'span.count')[0],e=DOM.scry(d,'span.countValue')[0],f=new CounterDisplay('messages_unread',e,d,null,null,true);var g=FutureSideNav.getInstance().getNodeForKey('other'),h=DOM.scry(g,'span.count')[0],i=DOM.scry(h,'span.countValue')[0],j=DOM.scry(h,'span.maxCountIndicator')[0];new CounterMaxDisplay('other_unseen',i,h,null,null,true).setMaxCounter(a,j);}function CounterMaxDisplay(){this._maxValue=null;this._maxIndicatorNode=null;var a=[this].concat($A(arguments));return this.parent.construct.apply(this.parent,a);}Class.extend(CounterMaxDisplay,'CounterDisplay');copy_properties(CounterMaxDisplay.prototype,{setMaxCounter:function(a,b){this._maxValue=a;this._maxIndicatorNode=b;},paint:function(){var a=this._maxValue&&this._count>this._maxValue,b=a?this._maxValue:this._count;if(this._maxIndicatorNode){DOM.setContent(this._maxIndicatorNode,a?'+':'');}else if(a)b=b+'+';DOM.setContent(this._valueNode,b);this._toggleNodes();}});
var MessagingConst={APP_ID:313785040330,XD_MESSAGE:{SANDBOX_READY:'sandbox_ready',SET_CONTENT:'set_content',HTML_SIZE:'html_size',REFRESH_SIZE:'refresh_size'},SHINGLE_SCROLL_TRIGGER:5,EVENTS:{MESSAGE_SENT:'messaging/message_sent'}};
function MessagingJewelMenubarController(a,b){this.parent.construct(this);this._content=ge(b);this._open=false;this._ua=new UserNoOp();Arbiter.subscribe([MessagingConst.EVENTS.MESSAGE_SENT,'chat/message-sent'],this._onSend.bind(this));Toggler.listen(['show','hide'],$(a),this._onToggle.bind(this));this._init();}Class.extend(MessagingJewelMenubarController,'MenubarMessageController');copy_properties(MessagingJewelMenubarController,{FETCH_URI:'/ajax/messaging/jewel_fetch.php',MARK_SEEN_URI:'/ajax/messaging/jewel_mark_seen.php',USER_ACTION_CONTEXT:'jewel',USER_ACTION_NAMESPACE:'messaging',ensureInitialized:function(a,b,c,d){if(MessagingJewelMenubarController.initialized||!ge(b))return false;var e=new MessagingJewelMenubarController(a,b);MessagingJewelMenubarController.instance=e;MenubarMessageController.instance=e;e.ensureInitialized(a,b,c,d);MessagingJewelMenubarController.initialized=true;}});copy_properties(MessagingJewelMenubarController.prototype,{_ua:null,_init:function(){this.initializeEvents();},initializeEvents:function(){var a=null;Event.listen(this._content,{mouseover:function(event){var b=event.getTarget();a=Parent.byTag(b,'li');if(a&&a!=b)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;}});},_fetch:function(){new AsyncRequest().setURI(MessagingJewelMenubarController.FETCH_URI).setMethod('GET').setData({action:'jewelPreview',seen:!this.fetchOnHover}).setReadOnly(true).setHandler(this._onFetchSuccess.bind(this)).setAllowCrossPageTransition(true).send();},_onFetchSuccess:function(){this._ua.add_event('fetch_success');Arbiter.inform.bind(Arbiter,'jewel/messages/fetched').defer(100);},_onSend:function(){this._dirty=true;},onCounterUpdate:function(){this.parent.onCounterUpdate();if(this._open)this.doRefetch();},_onToggle:function(a,b){this._open=(a=="show");this._ua=user_action(MessagingJewelMenubarController.USER_ACTION_CONTEXT).set_namespace(MessagingJewelMenubarController.USER_ACTION_NAMESPACE).set_ua_id('jewel_menu').add_event(a);if(this._open)this.doRefetch();},markSeen:function(){if(this.fetchOnHover)new AsyncSignal(MessagingJewelMenubarController.MARK_SEEN_URI,{action:'markSeen'}).send();}});
__e("ContextualLayerUpdateOnScroll",["event-extensions","Class","copyProperties"],function(a,b,c,d,e,f){b("event-extensions");var g=b("Class"),h=b("copyProperties");function i(j){this._layer=j;}h(i.prototype,{_subscriptions:[],enable:function(){this._subscriptions=[this._layer.subscribe('show',this._attachScrollListener.bind(this)),this._layer.subscribe('hide',this._removeScrollListener.bind(this))];},disable:function(){while(this._subscriptions.length)this._layer.unsubscribe(this._subscriptions.pop());this.detach();},_attachScrollListener:function(){if(this._listener)return;var j=this._layer.getContextScrollParent();this._listener=Event.listen(j,'scroll',this._layer.updatePosition.bind(this._layer));},_removeScrollListener:function(){this._listener&&this._listener.remove();this._listener=null;}});e.exports=i;});
__e("Quickling",["string-extensions","AjaxPipeRequest","Arbiter","dom","PageTransitions","DataStore","DocumentTitle","copyProperties","goOrReplace","isEmpty"],function(a,b,c,d,e,f){b("string-extensions");var g=b("AjaxPipeRequest"),h=b("Arbiter"),i=b("dom"),j=b("PageTransitions"),k=b("DataStore"),l=b("DocumentTitle"),m=b("copyProperties"),n=b("goOrReplace"),o=b("isEmpty"),p={isActive:function(){return p._is_active||false;},init:function(r,s,t){if(p._is_initialized)return;m(p,{_is_initialized:true,_is_active:true,_session_length:s,_is_in_transition:false,_title_interval:false,_ie_cache_title:'',_version:r});p._instrumentTimeoutFunc('setInterval');p._instrumentTimeoutFunc('setTimeout');p._inactivePageRegex=new RegExp(t);j.registerHandler(p._transitionHandler,1);},_startQuicklingTransition:function(){p._is_in_transition=true;},_stopQuicklingTransition:function(){(function(){p._is_in_transition=false;}).defer();},isPageActive:function(r){if(r=='#')return false;r=new URI(r);if(r.getDomain()&&r.getDomain()!=URI().getDomain())return false;if(r.getPath()=='/l.php'){var s=r.getQueryData().u;if(s){s=URI(unescape(s)).getDomain();if(s&&s!=URI().getDomain())return false;}}var t=r.getPath(),u=r.getQueryData();if(!o(u))t+='?'+URI.implodeQuery(u);return !p._inactivePageRegex.test(t);},_setHTML:function(r,s){if(ua.ie()<=6){r.innerHTML=s;}else i.setContent(r,HTML(s).setDeferred(true));},_transitionHandler:function(r){g.setCurrentRequest(null);if(p._isTimeToRefresh())return false;if(!p.isPageActive(r))return false;window.ExitTime=(new Date()).getTime();removeHook('onafterloadhooks');removeHook('onloadhooks');_runHooks('onleavehooks');h.inform('onload/exit',true);p._startQuicklingTransition();new q(r).setCanvasId('content').send();return true;},_changePageTitle:function(r){r=r||'Facebook';l.set(r);if(ua.ie()){p._ie_cache_title=r;if(!p._title_interval)p._title_interval=window.setInterval(function(){var s=p._ie_cache_title,t=l.get();if(s!=t)l.set(s);},5000,false);}},_replaceSyndicationLinks:function(r){var s=document.getElementsByTagName('link');for(var t=0;t<s.length;++t){if(s[t].rel!='alternate')continue;i.remove(s[t]);}if(r.length){var u=i.find(document,'head');u&&i.appendContent(u,HTML(r[0]));}},_isTimeToRefresh:function(){p._load_count=(p._load_count||0)+1;return p._load_count>=p._session_length;},_instrumentTimeoutFunc:function(r){window[r+'_native']=(function(s){var t=function t(u,v){return s(u,v);};return t;})(window[r]);window[r]=function _setTimeout(s,t,u){var v=window[r+'_native'](s,t);if(t>0)if(u!==false)onleaveRegister(function(){clearInterval(v);});return v;};}};function q(r){var s={version:p._version};this.parent.construct(this,r,{quickling:s});}Class.extend(q,'AjaxPipeRequest');q.prototype={_preBootloadFirstResponse:function(r){return true;},_fireDomContentCallback:function(){this._request.cavalry&&this._request.cavalry.setTimeStamp('t_domcontent');p._stopQuicklingTransition();j.transitionComplete();this._onPageDisplayed&&this._onPageDisplayed(this.pipe);this.parent._fireDomContentCallback();},_fireOnloadCallback:function(){if(this._request.cavalry){this._request.cavalry.setTimeStamp('t_hooks');this._request.cavalry.setTimeStamp('t_layout');this._request.cavalry.setTimeStamp('t_onload');}this.parent._fireOnloadCallback();},isPageActive:function(r){return p.isPageActive(r);},_versionCheck:function(r){if(r.version!=p._version){var s=['quickling','ajaxpipe','ajaxpipe_token'];n(window.location,URI(r.uri).removeQueryData(s),true);return false;}else return true;},_processFirstResponse:function(r){var s=r.getPayload();p._changePageTitle(s.title);p._replaceSyndicationLinks(s.syndication||[]);window.scrollTo(0,0);var t=s.body_class||'';CSS.setClass(document.body,t);},getSanitizedParameters:function(){return ['quickling'];}};e.exports=p;});
__e("enforceMaxLength",["event-extensions","function-extensions","dom","Input","InputSelection"],function(a,b,c,d,e,f){b("event-extensions");b("function-extensions");var g=b("dom"),h=b("Input"),i=b("InputSelection"),j=function(l,m){var n=h.getValue(l),o=n.length,p=o-m;if(p>0){var q,r;try{q=i.get(l);r=q.end;}catch(s){q=null;r=0;}if(r>=p)o=r;var t=o-p;if(t&&(n.charCodeAt(t-1)&64512)===55296)t--;r=Math.min(r,t);h.setValue(l,n.slice(0,t)+n.slice(o));if(q)i.set(l,Math.min(q.start,r),r);}},k=function(event){var l=event.getTarget(),m=l.getAttribute&&parseInt(l.getAttribute('maxlength'),10);if(m>0&&g.isNodeOfType(l,['input','textarea']))j.bind(null,l,m).defer();};Event.listen(document.documentElement,{keydown:k,paste:k});e.exports=j;});
function NotificationList(a,b){this._list=new DoublyLinkedListMap();this.unreadCount=0;this.contentRoot=a;this.noItemsElement=null;this.ITEM_TAG='li';this.ITEM_CLASS='notification';this.NO_ITEMS_ID='jewelNoNotifications';this.NO_ITEMS_CLASS='empty';this.compare=b.compare||this.compare;}copy_properties(NotificationList,{ITEM_UNREAD_CLASS:'jewelItemNew',MARK_READ_TYPE:'mark_read',UNREAD_COUNT_CHANGE_TYPE:'unread_count_change',getIdFromDom:function(a){return a.getAttribute('id').replace('notification_','');},localizeUrls:function(a){DOM.scry(a,'a').each(function(b){URI(b.href).isFacebookURI()&&(b.href=URI(b.href).getUnqualifiedURI().getQualifiedURI().setSubdomain(URI(b.href).getSubdomain()).toString());});}});Class.mixin(NotificationList,'Arbiter',{_getField:function(a,b){var c=this._list.get(a);return c&&c[b];},getDomObj:function(a){return this._getField(a,'obj');},fromDom:function(){var a=this.ITEM_TAG+'.'+this.ITEM_CLASS,b=DOM.scry(this.contentRoot,a);for(var c=0;c<b.length;++c){var d=b[c],e=NotificationList.getIdFromDom(d);this.insert(e,d.getAttribute('data-notiftime'),null);}},compare:function(a,b){return a.time<=b.time;},insert:function(a,b,c,d,e,f){var g=true,h=0,i=this._list.exists(a),j=f&&this._list.exists(f),k=null;if(i||j)if(!(d&&c)){return false;}else{g=this._getField(a,'unread');h=this._getField(a,'time');if(h>b)return false;k=i?a:f;this.remove(k);}var l=(c&&HTML(c).getRootNode())||$('notification_'+a),m=Math.max(b,h),n=CSS.hasClass(l,NotificationList.ITEM_UNREAD_CLASS),o={id:a,obj:l,time:m,unread:n};this._insert(o);NotificationList.localizeUrls(l);this.noItemsElement&&CSS.hide(this.noItemsElement);if(n){this.unreadCount=this.getUnreadIds().length;this.inform(NotificationList.UNREAD_COUNT_CHANGE_TYPE);e&&!g&&this.markRead([a]);}var p=!k||h<m||(n&&!g&&!e);Arbiter.inform('notif/insert',{id:a,is_new:p,obj:l,replaced_id:k});return true;},showNoNotifications:function(){if(null==this.noItemsElement)this.noItemsElement=ge(this.NO_ITEMS_ID);if(null==this.noItemsElement){this.noItemsElement=$N(this.ITEM_TAG,{id:this.NO_ITEMS_ID,className:this.NO_ITEMS_CLASS},"No new notifications");DOM.appendContent(this.contentRoot,this.noItemsElement);}CSS.show(this.noItemsElement);},_insert:function(a){this._list.remove(a.id);var b=null;this._list.find(function(d){var e=this.compare(d,a);!e&&(b=d.id);return e;}.bind(this));var c=this.getDomObj(b);if(c){this._list.insertAfter(a.id,a,b);DOM.insertAfter(c,a.obj);}else{this._list.prepend(a.id,a);DOM.prependContent(this.contentRoot,a.obj);}},remove:function(a){var b=this._getField(a,'obj');if(!b)return false;Arbiter.inform('notif/remove',{id:a});this.markRead([a]);this._list.remove(a);DOM.remove(b);this._list.isEmpty()&&this.showNoNotifications();return true;},_getIds:function(a,b){return this._list.reduce(function(c,d){!(c.unread?a:b)&&d.push(c.id);return d;},[]);},getUnreadIds:function(){return this._getIds(false,true);},getReadIds:function(){return this._getIds(true);},getIds:function(){return this._getIds();},isUnreadId:function(a){return this._getField(a,'unread');},markRead:function(a){a=a?a.filter(this.isUnreadId.bind(this)):this.getUnreadIds();for(var b=0;b<a.length;b++){var c=this._list.get(a[b]);if(c){this.inform(NotificationList.MARK_READ_TYPE,c.obj);c.unread=false;this._insert(c);}}if(a.length){this.unreadCount=this.getUnreadIds().length;this.inform(NotificationList.UNREAD_COUNT_CHANGE_TYPE);}},insertMany:function(a,b){if('object'==typeof a&&!is_empty(a)){for(var c in a){var d=a[c];this.insert(c,d.time,d.markup,true,b,d.alt_id||null);}this.noItemsElement&&CSS.hide(this.noItemsElement);}else this.isEmpty()&&this.showNoNotifications();},isEmpty:function(){return this._list.isEmpty();}});function Notifications(a){this.updateTime=a.updateTime||Date.now();this.user=Env.user;this.cache_version=a.cacheVersion||0;this.allowDesktopNotifications=a.allowDesktopNotifications||false;this.latest_notif_time=a.latestNotif||0;this.latest_read_notif_time=a.latestReadNotif||0;this.update_period=a.updatePeriod||60000;this.notifReceivedType=a.notifReceivedType||'notification';this.wrapperID=a.wrapperID||'notificationsWrapper';this.contentID=a.contentID||'jewelNotifs';this.timeElement='small.time';this.shouldLogImpressions=a.shouldLogImpressions||false;this.ua=new UserNoOp();this._init();}Notifications.BEEPS_EXPIRED='beeper/beeps_expired';Notifications.prototype={_init:function(){this.cookieName='notifications_'+this.user;this.beepsExpiredToken=null;this.updateCheckCount=0;this.fetchListeners=[];this.currentFetchRequest=null;this.wrapper=ge(this.wrapperID);this.content=ge(this.contentID);this.jewelFlyout=ge('fbNotificationsFlyout');this.loadingIndicator=ge(this.contentID+'_loading_indicator');NotificationCounter.init();this.alertList=new NotificationList(this.content,this._getListParams());this._updateCount();window.MinNotifications&&MinNotifications.fetched()&&(this.fetch=bagofholding);Arbiter.subscribe(PresenceMessage.getArbiterMessageType(this.notifReceivedType),this._handleNotificationMsg.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('notifications_read'),this._handleNotificationsReadMsg.bind(this));this.alertList.subscribe(NotificationList.UNREAD_COUNT_CHANGE_TYPE,this._updateCount.bind(this));this._poller=new Poller(this.update_period,this._update.bind(this),true);if(this.wrapper)this.countSpan=DOM.find(this.wrapper,'span.jewelCount span');this.initializeEvents();this.fromDom();},_getListParams:function(){return {};},fromDom:function(){this.alertList.fromDom();},initializeEvents:function(){var a=null;Event.listen(this.content,{mouseover:function(event){var c=event.getTarget();a=Parent.byTag(c,'li');if(a&&c!=a)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;}});Event.listen(this.wrapper,'mouseover',this.onMouseOver.bind(this));Toggler.listen('show',this.wrapper,this.onClick.bind(this));Toggler.listen('hide',this.wrapper,this.onHide.bind(this));this.shouldLogImpressions&&Toggler.listen('show',this.wrapper,this.logImpression.bind(this));var b=this._poller.requestNow.shield(this._poller);SystemEvents.subscribe(SystemEvents.TIME_TRAVEL,b);SystemEvents.subscribe(SystemEvents.ONLINE,function(c,d){d&&b();});},onMouseOver:function(event){this.ua=user_action('jewel',event.target,event).set_namespace('notifs').set_ua_id('prefetch').add_event('hover');this.fetch();},onClick:function(){window.ArbiterMonitor&&this.fetch!=bagofholding&&Arbiter.registerCallback(bagofholding,['notifs/fetched']);this.ua.add_event('show');this.fetch();this.markRead(true);},onHide:function(){this.ua.add_event('hide');this.markRead(true);},_sendIDs:function(a,b){var c={};c.user=this.user;for(var d=0;d<a.length;++d)c['alert_ids['+d+']']=a[d];new AsyncSignal(URI(b).getQualifiedURI().toString(),c).send();},_waitForFetch:function(a){return this.currentFetchRequest&&this.fetchListeners.push(a.bind(this));},logImpression:function(){var a=this.alertList.getIds();if(a.length===0&&this._waitForFetch(this.logImpression))return;this._sendIDs(a,'/ajax/notifications/impression.php');},signalMarkRead:function(a){a=a||[];if(a.length===0&&this._waitForFetch(this.signalMarkRead))return;this._sendIDs(a,'/ajax/notifications/mark_read.php');},markRead:function(a,b){if(this.alertList.unreadCount===0)return;a&&this.signalMarkRead(b);this.alertList.markRead(b);this._updateCount();},_updateErrorHandler:function(a){},_updateURI:'/ajax/presence/update.php',_update:function(a){a.setHandler(this._handleUpdate.bind(this)).setOption('suppressErrorAlerts',true).setErrorHandler(this._updateErrorHandler.bind(this)).setData({user:this.user,notif_latest:this.latest_notif_time,notif_latest_read:this.latest_read_notif_time}).setURI(this._updateURI).setAllowCrossPageTransition(true);},_handleUpdate:function(a){var b=a.payload.notifications;if(!b.no_change){this.updateTime=a.payload.time;this.latest_notif_time=b.latest_notif;this.latest_read_notif_time=b.latest_read_notif;this._updateDisplayDelayed();this.alertList.insertMany(b.notifications);}},_updateDisplayDelayed:function(){if(typeof Beeper!='undefined'){this.beepsExpiredToken=Arbiter.subscribe(Notifications.BEEPS_EXPIRED,this._updateDisplay.bind(this));}else this._updateDisplay();},_updateDisplay:function(){if(!this.content)return;this._updateCount();if(this.beepsExpiredToken)Arbiter.unsubscribe(this.beepsExpiredToken);},_updateCount:function(){Arbiter.inform('jewel/count-updated',{jewel:'notifications',count:this.alertList.unreadCount},Arbiter.BEHAVIOR_STATE);},fetch:function(){var a=URI('/ajax/notifications/get.php');if(this.currentFetchRequest)return true;this.ua.add_event('fetch');a.setQueryData({time:this.latest_notif_time,user:this.user,version:this.cache_version,locale:Env.locale});this.currentFetchRequest=new AsyncRequest().setURI(a).setStatusElement(this.loadingIndicator).setMethod('GET').setReadOnly(true).setTimeoutHandler(30000,this.fetchErrorHandler.bind(this)).setHandler(this.fetchHandler.bind(this)).setErrorHandler(this.fetchErrorHandler.bind(this)).setAllowCrossPageTransition(true);!this.currentFetchRequest.send()&&this.fetchErrorHandler();return true;},fetchErrorHandler:function(a){this.currentFetchRequest=null;this.ua.add_event('fetch_error');},fetchHandler:function(a){this.ua.add_event('fetch_success');var b=a.getPayload();this.alertList.insertMany(b.notifications,true);this.loadingIndicator&&CSS.hide(this.loadingIndicator);this.loadingIndicator=null;this.currentFetchRequest=null;this.fetch=bagofholding;if(this.fetchListeners){for(var c=0;c<this.fetchListeners.length;c++)this.fetchListeners[c]();this.fetchListeners=[];}window.ArbiterMonitor&&Arbiter.inform('notifs/fetched','',Arbiter.BEHAVIOR_STATE);},_mergeNotification:function(a,b,c,d){var e=!this.alertList.isUnreadId(a);this.alertList.insert(a,b,c,true,null,d||null);this.latest_notif_time=0;if(e)this._updateCount();},_handleNotificationMsg:function(a,b){var c=b.obj;if(typeof this.useDesktopNotifications=='undefined'){var d;this.useDesktopNotifications=this.allowDesktopNotifications&&window.webkitNotifications&&window.webkitNotifications.checkPermission()===0;}if(this.useDesktopNotifications)Bootloader.loadComponents('desktop-notifications',function(){DesktopNotifications.addNotification(c.alert_id);});if(c.markup){this._mergeNotification(c.alert_id,c.time,c.markup,c.alt_id||null);}else this._poller.requestNow();},_handleNotificationsReadMsg:function(a,b){var c=b.obj;if(typeof Beeper!='undefined')Beeper.getInstance().markRead(false,c.alert_ids);this.markRead(false,c.alert_ids);},isTabOpen:function(){return this.wrapper&&CSS.hasClass(this.wrapper,'openToggler');}};
function OriginalNotifications(a){this.parent.construct(this,a);}Class.extend(OriginalNotifications,'Notifications');copy_properties(OriginalNotifications.prototype,{_init:function(){this.ignoreBeeps=false;this.parent._init();this.alertList.subscribe(NotificationList.MARK_READ_TYPE,this._animateMarkRead.bind(this));Arbiter.subscribe('jewel/resize',this._hideOverflow.shield(this));},initializeEvents:function(){this.parent.initializeEvents();if(Parent.byClass(this.wrapper,'notifJewelBeeper')&&(this.beeper=window.NotifBeeper))this._initBeeper();},fromDom:function(){this.ignoreBeeps=true;this.parent.fromDom();this.ignoreBeeps=false;},_initBeeper:function(){this.beeper.init(this.jewelFlyout);Arbiter.subscribe('notif/insert',function(a,b){if(Toggler.getInstance(this.wrapper).getActive()!==this.wrapper&&!this.ignoreBeeps&&this.alertList.isUnreadId(b.id))b.is_new?this.beeper.addBeep(b.id,b.obj):this.beeper.updateBeep(b.replaced_id,b.id,b.obj);}.bind(this));Arbiter.subscribe('notif/remove',function(a,b){this.beeper.removeBeep(b.id);}.bind(this));Event.listen(this.wrapper,'click',function(){if(!this.beeper.empty()){this.beeper.clearBeeps();return false;}}.bind(this));},fetchHandler:function(a){this.parent.fetchHandler(a);var b=a.getPayload(),c=b.generated,d=Math.round((new Date()).getTime()/1000);if(d-c>15)c=d;Bootloader.loadComponents('live-timer',function(){LiveTimer.restart(c);LiveTimer.startLoop(0);});this._hideOverflow();},_mergeNotification:function(a,b,c,d){this.parent._mergeNotification(a,b,c,d);var e=this.alertList.getDomObj(a);if(e)Bootloader.loadComponents('live-timer',function(){LiveTimer.addTimeStamps(e);});},_animateMarkRead:function(a,b){animation(b).duration(5000).checkpoint().from('backgroundColor','#EFF1F7').to('backgroundColor','#FFFFFF').duration(2250).ondone(CSS.removeClass.bind(null,b,NotificationList.ITEM_UNREAD_CLASS)).go();},onClick:function(){this.beeper&&this.beeper.clearBeeps();this.parent.onClick();this._hideOverflow();},_updateCount:function(){this.parent._updateCount();this._hideOverflow();},_hideOverflow:function(a,b){a=a||DOM.find(this.jewelFlyout,'.jewelFooter');b=b||DOM.scry($('fbNotificationsList'),'.notification');var c=CSS.hasClass($('jewelContainer'),'notifJewelScroll');if(!b.length||(CSS.hasClass(document.documentElement,'tinyViewport')&&!CSS.hasClass(document.body,'fixedBody'))){if(c){CSS.setStyle(DOM.find(this.jewelFlyout,'.uiScrollableArea'),'height','100%');}else b.each(CSS.show);return;}var d=c&&DOM.find(this.jewelFlyout,'.uiScrollableArea'),e=d||b[0],f=Vector2.getViewportDimensions().y-Vector2.getElementPosition(e,'viewport').y-Vector2.getElementDimensions(a).y-5,g=f,h=0;for(;h<b.length&&g>0;++h){!c&&CSS.show(b[h]);g-=Vector2.getElementDimensions(b[h]).y;}if(c){var i=530,j=Math.min(i,f-Math.max(g,0));if(g>=0&&j<i){j='100%';}else j+='px';CSS.setStyle(d,'height',j);return;}g<0&&--h;for(;h<b.length;++h)CSS.hide(b[h]);}});
function SearchDataSource(a){this._token=a.token||'';this._lazyonload=a.lazyonload===false?false:true;this._leanOnAllTypes=a.leanOnAllTypes;this._extraTypes=a.extraTypes;this._buckets=a.buckets;this._noMultiFetch=a.noMultiFetch||false;var b=a.maxResults||8;this.parent.construct(this,a);this._numResults={min:3,max:b};this._genTime=a.genTime;}Class.extend(SearchDataSource,'DataSource');SearchDataSource.prototype={init:function(){this.parent.init();this._leanPayload=null;this._bootstrapRequestsPending=0;this._criticalOnly=true;this._updateMaxResults();Event.listen(window,'resize',this._updateMaxResults.bind(this));},dirty:function(){this.parent.dirty();this._fetchOnUseRequests=[];},asyncErrorHandler:function(a){if(window.Dialog&&Dialog.getCurrent()==null&&a.getError()==1400003)AsyncResponse.verboseErrorHandler(a);},fetch:function(a,b,c){c=c||{};c.fetch_start=Date.now();this.parent.fetch(a,b,c);},fetchHandler:function(a,b){var c=a.getPayload(),d=copy_properties({fetch_end:Date.now()},b),e=d.value?Arbiter.BEHAVIOR_EVENT:Arbiter.BEHAVIOR_PERSISTENT;if(b.type=='lean'){this._leanPayload=c;this._processLean();}else{if(c.coeff2_ts)d.coeff2_ts=c.coeff2_ts;this.parent.fetchHandler(a,b);if(b.bootstrap&&!a.getRequest().getData().no_cache)d.browserCacheHit=(c.timestamp<this._genTime);if(b.bootstrap&&!c.no_data&&this._bootstrapRequestsPending>0){b.bootstrap=false;--this._bootstrapRequestsPending;!this._bootstrapRequestsPending&&this._bootstrapPostProcess();}if(c.no_data||c.token!==this._token){var f=copy_properties({},a.getRequest().getData());if(f.lazy){delete f.lazy;f.token=this._token;this._fetchOnUse(f,b);}}}this.inform('endpointStats',d,e);},_bootstrapPostProcess:function(){var a={time:Date.now()};this.inform('bootstrapped',a,Arbiter.BEHAVIOR_PERSISTENT);this._processLean();},_processLean:function(){if(this._leanPayload){var a,b=this._leanPayload.entries;for(var c in b){a=this.getEntry(c);a&&(a.index=b[c]);}this.setExclusions(this._leanPayload.blocked);this._leanPayload=null;}},_updateMaxResults:function(){var a=window.innerHeight||document.documentElement.clientHeight;this.setMaxResults(Math.max(this._numResults.min,Math.min(this._numResults.max,Math.ceil(2+((a-370)/56)))));},_bootstrapFetch:function(a,b){var c=copy_properties(b,this.bootstrapData);if(this._criticalOnly&&this._lazyonload)c.lazy=1;this.fetch(this.bootstrapEndpoint,c,{bootstrap:true,type:a});++this._bootstrapRequestsPending;},_fetchOnUse:function(a,b){for(var c in this.bootstrapData)!a.hasOwnProperty(c)&&(a[c]=this.bootstrapData[c]);if(this._criticalOnly){this._fetchOnUseRequests.push({args:a,ctx:b});}else this.fetch(this.bootstrapEndpoint,a,b);},_fetchLean:function(){var a={filter:['user'],no_cache:1};if(this._leanOnAllTypes)a={no_cache:1};a.options=$A(a.options);a.options.push('lean');this._fetchOnUse(a,{type:'lean'});},bootstrap:function(a){if(!a){this._criticalOnly=false;this._flushFetchOnUseRequests();}if(this._bootstrapped)return;var b={filter:['event'],no_cache:1};this._fetchOnUse(b,{type:'event'});var c=['app','page','group','friendlist'];c=c.concat(this._extraTypes||[]);if(this._noMultiFetch){c.push('user');this._bootstrapFetch('user',{filter:c});}else{this._bootstrapFetch('other',{filter:c});if(this._buckets){for(var d=0;d<this._buckets.length;++d){var e={filter:['user'],buckets:this._buckets[d]};this._bootstrapFetch('user',e);}}else this._bootstrapFetch('user',{filter:['user']});}this._fetchLean();this._bootstrapped=true;},_flushFetchOnUseRequests:function(){var a=this._fetchOnUseRequests.length;for(var b=0;b<a;++b){var c=this._fetchOnUseRequests[b];this.fetch(this.bootstrapEndpoint,c.args,c.ctx);}this._fetchOnUseRequests=[];},onLoad:function(a,b){this.inform('onload',{time:Date.now()},Arbiter.BEHAVIOR_PERSISTENT);if(a)this.bootstrap.bind(this,b).defer();}};
function SearchTypeaheadCore(a){this.parent.construct(this,a);}Class.extend(SearchTypeaheadCore,'TypeaheadCore');SearchTypeaheadCore.prototype={init:function(a,b,c){this.parent.init(a,b,c);var d=Parent.byTag(c,'form'),e=this.reset.bind(this);if(d){var f=DOM.find(d,'input.search_sid_input');Event.listen(d,'submit',function(){if(this.data&&this.data.queryData)f.value=this.data.queryData.sid;e.defer();}.bind(this),Event.Priority.URGENT);}},select:function(){this.reset();this.element.focus();(function(){this.element.blur();}).bind(this).defer();},handleTab:function(event){var a=this.view.getQuerySuggestion(this.value);if(a){Input.setValue(this.element,a);this.checkValue();event.kill();}else this.parent.handleTab(event);}};
function BucketedTypeaheadView(a,b){this.parent.construct(this,a,b);}Class.extend(BucketedTypeaheadView,'ContextualTypeaheadView');BucketedTypeaheadView.prototype={render:function(a,b,c){b=this.buildBuckets(a,b);return this.parent.render(a,b,c);},highlight:function(a,b){if(a==-1&&this.index!==0)a=this.index;if(a>=0&&a<this.items.length&&this.results[a].type=='header')a=a+1;this.parent.highlight(a,b);},buildBuckets:function(a,b){if(!this.typeObjects)return b;var c=[],d={};for(var e=0;e<b.length;++e){var f=b[e],g=f.render_type||f.type;if(!d.hasOwnProperty(g)){d[g]=c.length;c.push([this.buildBucketHeader(g)]);}f.classNames=g;f.groupIndex=d[g];f.indexInGroup=c[f.groupIndex].length-1;c[f.groupIndex].push(f);}var h=[];for(var i=0;i<c.length;++i)h=h.concat(c[i]);return h;},buildBucketHeader:function(a){var b=this.typeObjects[a];if(b.markup){b.text=b.markup;delete b.markup;}return this.typeObjects[a];},buildResults:function(a){var b=this.parent.buildResults(a);return $N('div',{className:'bucketed'},[b]);},select:function(a){var b=this.results[this.index];if(b&&b.type!='header')this.parent.select(a);},getDefaultIndex:function(a){var b=(this.autoSelect&&!this.disableAutoSelect),c=a.length===0?-1:(a[0].type=='header'?1:0);return this.index<0&&!b?-1:c;},prev:function(){var a=this.results[this.index-1];if(a&&a.type=='header')this.index--;return this.parent.prev();},next:function(){var a=this.results[this.index+1];if(a&&a.type=='header')this.index++;return this.parent.next();}};
__e("legacy:contextual-layer-update-on-scroll",["ContextualLayerUpdateOnScroll"],function(a,b,c,d){a.ContextualLayerUpdateOnScroll=b('ContextualLayerUpdateOnScroll');},3);
function SearchTypeaheadView(a,b){this.parent.construct(this,a,b);}Class.extend(SearchTypeaheadView,'BucketedTypeaheadView');SearchTypeaheadView.prototype={initializeLayer:function(){this.parent.initializeLayer();this.layer.setOffsetY(-1);this.layer.enableBehavior(ContextualLayerUpdateOnScroll);},ignoreClick:function(event){event.prevent();},shouldShowSeeMore:true,queryData:{init:'quick'},buildBuckets:function(a,b){var c=b.length;if(a&&this.shouldShowFindFriends)b.push({text:"Find Friends",category:"Find more friends using the Find Friends tool",path:"/find-friends",photo:"/images/growth/find_friends.png",type:"user"});b=this.parent.buildBuckets(a,b);if(a&&this.shouldShowSeeMore)b.push(this.buildSeeMore(a,c));return b;},buildSeeMore:function(a,b){var c=b>0?tx._("See more results for {query}",{query:a}):tx._("See results for {query}",{query:a}),d=b==1?"Displaying top result":tx._("Displaying top {number} results",{number:b}),e=$N('li',{className:'calltoaction'},[$N('a',{href:this.getSeeMoreEndpoint(a),rel:'ignore'},[$N('span',{className:'text'},[$N('span',{className:'seeMore'},[c,$N('span',{className:'arrow'})]),$N('span',{className:'subtext'},[d])])])]);return {uid:'search',node:e,search:true};},searchPageQueryData:function(a){return copy_properties({q:a},this.queryData||{});},select:function(a){var b=this.index,c=this.results[b];if(!c||c.type=='header')return;var d=this.items[b],e=DOM.scry(d,'a')[0];if(c.song){if(e)MusicEvents.inform(MusicConstants.MUSIC_BUTTON.ACTIVATE,e);a&&this.inform('highlight',{index:b,selected:c});}else{this.parent.select(a);if(e&&e.href)if(e.target=='_blank'){window.open(e.href);}else goURI(e.href);}},setSid:function(a){this.queryData.tas=a;},getSeeMoreEndpoint:function(a){return URI(this.seeMoreEndpoint).addQueryData(this.searchPageQueryData(a)).toString();},show:function(){if(!this.isVisible()){Arbiter.inform('layer_shown',{type:'SearchTypeahead'});this.parent.show();}},hide:function(){if(this.isVisible()){Arbiter.inform('layer_hidden',{type:'SearchTypeahead'});this.parent.hide();}},getQuerySuggestion:function(a){var b=this.results[this.index],c=b&&b.type!='header'?b.text.toLowerCase():'';return c==a.toLowerCase()?'':c;}};
function SearchTypeaheadRecorder(a){this.init(a);this.initEvents();}SearchTypeaheadRecorder.prototype={_endPoint:'/ajax/typeahead/record_metrics.php',init:function(a){this.core=a.getCore();this.data=a.getData();this.view=a.getView();this.element=this.core.getElement();this.initTime=Date.now();this._onloadTime=0;this.initStartTime=$('search_first_focus').value;this.bootstrapStats={bootstrapped:0};this._reset();},_reset:function(){this.stats={};this.avgStats={};this.appendStats={};this._backspacing=false;this._inflightRequests={};var a=Math.random();this.data.setQueryData({sid:a});this.view.setSid(a);this.recordStat('sid',a);},initEvents:function(){this.core.subscribe('focus',function(event){if(!this.stats.session_start_time)this.recordStat('session_start_time',Date.now());}.bind(this));this.core.subscribe('blur',function(event){var a=Date.now();for(var b in this._inflightRequests){var c=this._inflightRequests[b],d=a-c;this.recordAvgStat('search_endpoint_ms_from_js',d);}this.recordStat('session_end_time',a);this.submit();}.bind(this));this.view.subscribe('select',function(a,b){this.recordSelectInfo(b);}.bind(this));this.view.subscribe('render',function(a,b){this.recordRender(b);}.bind(this));this.data.subscribe('activity',function(a,b){this.recordStat('pending_request',b.activity);}.bind(this));this.data.subscribe('beforeQuery',function(a,b){if(!b.value)return;if(!this.stats.first_query_time)this.recordStat('first_query_time',Date.now());this.query=b.value;this.recordCountStat('num_queries');}.bind(this));this.data.subscribe('queryEndpoint',function(a,b){this.recordCountStat('num_search_ajax_requests');this.recordAvgStat('endpoint_query_length',b.value.length);this._inflightRequests[b.value]=Date.now();}.bind(this));this.data.subscribe('onload',function(a,b){this._onloadTime=b.time;}.bind(this));this.data.subscribe('bootstrapped',function(a,b){this.bootstrapStats.endTime=b.time;this.bootstrapStats.bootstrapped=1;}.bind(this));this.data.subscribe('endpointStats',function(a,b){var c=b.fetch_end-b.fetch_start;if(b.value){this.recordAvgStat('search_endpoint_ms_from_js',c);}else this.bootstrapStats[b.type]=c;if(b.coeff2_ts)this.bootstrapStats.coeff2_ts=b.coeff2_ts;if(typeof b.browserCacheHit!='undefined')this.recordCountStat(b.browserCacheHit?'bootstrap_cachehits':'bootstrap_cachemisses');if(this._inflightRequests[b.value])delete this._inflightRequests[b.value];}.bind(this));this.data.subscribe('query',function(a,b){this.recordAvgStat('num_results_from_cache',b.results.length);}.bind(this));Event.listen(this.element,'keydown',function(event){if(Event.getKeyCode(event)==KEYS.BACKSPACE){if(!this._backspacing){this._backspacing=true;this.recordAppendStat('before_backspace_queries',this.query);}}else this._backspacing=false;}.bind(this));},recordStat:function(a,b){this.stats[a]=b;},recordCountStat:function(a){var b=this.stats[a];this.stats[a]=b?b+1:1;},recordAvgStat:function(a,b){if(this.avgStats[a]){this.avgStats[a][0]+=b;++this.avgStats[a][1];}else this.avgStats[a]=[b,1];},recordAppendStat:function(a,b){if(!this.appendStats.hasOwnProperty(a))this.appendStats[a]=[];this.appendStats[a].push(b);},recordRender:function(a){this.results=a.filter(function(b){return b.uid!='search'&&b.type!='header';});if(this.results.length>0&&!this.stats.first_result_time)this.recordStat('first_result_time',Date.now());},recordSelectInfo:function(a){var b=a.selected,c=a.index-b.groupIndex-1,d={href:b.path},e=b.dataGT?{gt:JSON.parse(b.dataGT)}:{};user_action('click',d,null,null,e);if(b.uid=='search'){this.recordStat('selected_search',1);}else{var f=b.rankType||b.render_type||b.type,g=(f=='friend'?'user':f);this.recordStat('selected_'+g,1);this.recordStat('selected_position',c);this.recordStat('selected_type',f);this.recordStat('selected_name_length',b.text.length);this.recordStat('selected_id',b.uid);this.recordStat('selected_degree',b.bootstrapped?1:2);}this.recordStat('selected_with_mouse',a.clicked?1:0);},_dataToSubmit:function(){this.recordStat('candidate_results',this.buildResults());this.recordStat('query',this.query);this.recordStat('init_time',this.initTime);if(this.initStartTime){this.recordStat('init_start_time',this.initStartTime);this.recordStat('onload_time',this._onloadTime);this.initStartTime=0;}this.recordStat('bootstrapped',this.bootstrapStats.bootstrapped);if(this.bootstrapStats.endTime){this.recordStat('bootstrapped_time',this.bootstrapStats.endTime);this.recordStat('user_bootstrap_ms',this.bootstrapStats.user);this.recordStat('other_bootstrap_ms',this.bootstrapStats.other);this.bootstrapStats.endTime=0;}this.recordStat('coeff2_ts',this.bootstrapStats.coeff2_ts);this.recordStat('max_results',this.data._maxResults);var a=this.stats;for(var b in this.avgStats){var c=this.avgStats[b];a[b]=c[0]/c[1];}for(var d in this.appendStats)a[d]=JSON.stringify(this.appendStats[d]);return a;},buildResults:function(){var a=(this.results||[]).map(function(b,c){var d=b.rankType||b.render_type||b.type,e=b.bootstrapped?1:0;if(typeof b.groupIndex=='number')return [b.groupIndex,b.indexInGroup,b.uid,d,e];return [0,c,b.uid,d,e];});return JSON.stringify(a);},submit:function(){var a=this._dataToSubmit();if(count(a)>0)new AsyncRequest().setURI(this._endPoint).setMethod('POST').setData({stats:a}).setOption('handleErrorAfterUnload',true).setErrorHandler(function(b){a.retry=true;new AsyncRequest().setURI(this._endPoint).setMethod('POST').setData({stats:a}).setOption('asynchronous',false).send();}.bind(this)).send();this._reset();}};
add_properties('TypeaheadBehaviors',{searchRecorderBasic:function(a){a.subscribe('init',function(b,c){new SearchTypeaheadRecorder(a);});}});
add_properties('TypeaheadRenderers',{search:function(a,b){var c=[];if(a.photo){c.push($N('img',{className:'photo',alt:'',src:a.photo}));if(a.song){c.push($N('span',{className:'playButton'}));c.push($N('span',{className:'playLoader'}));}}if(a.text){var d=a.alias,e=this.value,f=a.text,g=[f];if(d&&TypeaheadUtil.isQueryMatch(e,d)&&!TypeaheadUtil.isQueryMatch(e,f))g.push($N('span',{className:'alias'},[' \xB7 '+d]));c.push($N('span',{className:'text'},g));}if(a.category){var h=[a.category];if(a.is_external)h.push($N('span',{className:'arrow'}));c.push($N('span',{className:'category'},h));}if(a.subtext)c.push($N('span',{className:'subtext'},[a.subtext]));var i=a.classNames||a.type||'',j=a.is_external?'_blank':'',k=!a.song&&a.path||'';if(k){if(!(/^https?\:\/\//).test(k))k=Env.www_base+k.substr(1);k+=(k.indexOf('?')>0?'&':'?')+'ref=ts';}var l=$N('a',{href:k,rel:'ignore',target:j},c);if(a.song){l.id='mb_'+(Math.random()*1e+06|0);MusicButtonManager.addButton.curry(a.song.provider,l.id,a.song.url,a.song.context,a.song.media_type).defer();l.onclick=this.ignoreClick;}return $N('li',{className:i},[l]);}});
void(0);
add_properties('TypeaheadBehaviors',{initFilters:function(a){Arbiter.subscribe('search/typeahead/updateFilter',function(b,c){a.getView().queryData.type=c.filter_type;});Arbiter.subscribe('page_transition',function(b,c){delete a.getView().queryData.type;},Arbiter.SUBSCRIBE_NEW);}});
function UIIntentionalStream(a,b,c,d,e,f,g,h,i,j,k,l,m,n){if(!a)throw new Error('UIIntentionalStream instantiated with no root.');copy_properties(this,{id:a.id,root:a,instanceName:b,newest:c,oldest:d,oldestMR:d,firstLoadIDs:h,shouldShowHidden:false,defaultFilter:e,currentFilterKey:j,sourceType:f,lastSeenTime:k,hasPendingRefresh:false,pauseAutoInsert:false,error:DOM.scry(a,'div.UIIntentionalStream_Error')[0],pager:DOM.scry(a,'div.uiMorePager')[0],filterNullState:DOM.scry(a,'div.friendListFilterNullState')[0],streamContent:DOM.find(a,'.UIIntentionalStream_Content'),requestNum:0,scrollLoadCount:1,maxScrollLoadCount:1,lastViewStateID:0,shouldRenderCount:n,scrollListener:null,conowingoCount:0,conowingoNewest:0});onleaveRegister(this.unload.bind(this));if(!UIIntentionalStream.instances)UIIntentionalStream.instances={};UIIntentionalStream.instances[b]=this;UIIntentionalStream.instance=this;this.setupAutoInsert();this.setupSubscriptions();}UIIntentionalStream.isHighlightsFilter=function(a){if(!a)return false;var b=a.startsWith(UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS);return b;};UIIntentionalStream.prototype.subscribeToComposerPublish=function(){this.subscriptions.push(Arbiter.subscribe('composer/publish',function(event,a){if(a.streamStory)this.addComposerContent(a.streamStory,500);}.bind(this)));};UIIntentionalStream.prototype.setupSubscriptions=function(){this.subscriptions=[];this.subscribeToComposerPublish();this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,this.updateStream.bind(this)));this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,this.refreshStream.bind(this)));this.scrollListener=Event.listen(window,'scroll',this.checkScroll.bind(this));this.checkScroll();};UIIntentionalStream.prototype.tearDownSubscriptions=function(){if(!this.subscriptions)return;this.subscriptions.forEach(Arbiter.unsubscribe);this.subscriptions=null;if(this.scrollListener){this.scrollListener.remove();this.scrollListener=null;}};UIIntentionalStream.prototype.unload=function(){this.tearDownSubscriptions();UIIntentionalStream.instance=null;UIIntentionalStream.instances[this.instanceName]=null;this.clearScrollLoader(true);window.disableScrollLoad=null;UIIntentionalStreamRefresh.instance&&UIIntentionalStreamRefresh.instance.unload();};UIIntentionalStream.getInstance=function(a){return UIIntentionalStream.instances[a];};UIIntentionalStream.prototype._getUpdateInsertType=function(){if(this.isOnNewHighlights()&&(!this.boulderFeed||this.shouldRenderCount))return UIIntentionalStream.REFRESH_COUNT;return UIIntentionalStream.REFRESH_PREPEND;};UIIntentionalStream.prototype.updateStream=function(a){if(a!=UIIntentionalStreamMessage.UPDATE_STREAM||this.hasPendingRefresh||this.isAutoRefreshPaused())return;this.loadNewer({showLoader:false,ignoreSelf:true,insertType:this._getUpdateInsertType()});};UIIntentionalStream.prototype.clearScrollLoader=function(a){if(this.currentScrollListener){this.currentScrollListener.remove();this.currentScrollListener=null;}if(a||this.scrollLoadCount>=this.maxScrollLoadCount)window.disableScrollLoad=true;};UIIntentionalStream.prototype.loadOlderPosts=function(a){var b={filter:this.getCurrentFilterKey(),oldest:this.oldest,oldestMR:this.oldestMR,last_seen_time:this.lastSeenTime,scroll_count:this.scrollLoadCount,scroll_position:this.scrollPosition,last_viewstate_id:this.lastViewStateID};b=merge(b,a);this.loadWithParams(b);};UIIntentionalStream.prototype.loadWithParams=function(a){var b=DOM.scry(this.root,'div.fbStreamPager.hasMorePosts')[0];if(b){if(CSS.hasClass(b,'async_saving'))return;CSS.addClass(b,'async_saving');}UIPagelet.loadFromEndpoint('MoreStoriesPagelet','home_stream',a,{usePipe:true,append:true});};UIIntentionalStream.prototype.setScrollLoadCount=function(a){this.maxScrollLoadCount=a;};UIIntentionalStream.prototype.loadMoreOnScroll=function(a,b,c){if(window.disableScrollLoad)return;var d=function(){if(window.disableScrollLoad)return;if(window.ArbiterMonitor){var g=user_action('scroll',null,null,'FORCE',{gt:{ua_id:'stream:scroll:auto'}});g.set_namespace('stream');ArbiterMonitor.initUA(g);}var h={delay_load_count:b};this.loadOlderPosts(h);}.bind(this),e=DOM.scry(this.root,'ul.uiStream li.genericStreamStory');if(!e.length)return;var f=e[e.length-a-1];if(f){this.currentScrollListener=new OnVisible(f,d,null,0,{detect_speed:this.scrollLoadCount>1});}else d();};UIIntentionalStream.prototype.updateTimeRange=function(a,b){if(!this.newest||this.newest<a)this.newest=a;if(!this.oldest||(b&&(b<this.oldest)))this.oldest=b;};UIIntentionalStream.prototype.updateOldestMR=function(a){if(!this.oldestMR||a<this.oldestMR)this.oldestMR=a;};UIIntentionalStream.prototype.updateScrollPosition=function(a){this.scrollPosition=a;};UIIntentionalStream.prototype.updateLastViewStateID=function(a){this.lastViewStateID=a;};UIIntentionalStream.prototype.getID=function(){return this.id;};UIIntentionalStream.prototype.getCurrentFilterKey=function(){if(this.currentFilterKey)return this.currentFilterKey;var a=URI.getMostRecentURI().getQueryData();if(a&&a.sk){this.currentFilterKey=a.sk;}else if(a&&a.filter){this.currentFilterKey=a.filter;}else if(this.defaultFilter)this.currentFilterKey=this.defaultFilter;return this.currentFilterKey;};UIIntentionalStream.prototype.resetFilterKey=function(a){this.currentFilterKey=a;};UIIntentionalStream.prototype.loadOlder=function(a){a=a||{};if(!this.oldest)return;var b=this.getCurrentParams();b.oldest=this.oldest;this.refresh(UIIntentionalStream.REFRESH_APPEND,b,a);return this;};UIIntentionalStream.prototype.loadNewer=function(a){if(!this.newest)return;a=a||{};var b=this.getCurrentParams();b.newest=this.newest;if(a.ignoreSelf)b.ignore_self=true;b.load_newer=true;var c=coalesce(a.insertType,UIIntentionalStream.REFRESH_PREPEND);this.refresh(c,b,a);return this;};UIIntentionalStream.prototype.expandRecentStories=function(){if(!this.shouldRenderCount)return;this.shouldRenderCount=false;var a=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer'),b=this.getCurrentParams();b.newest=this.newest;b.active_mode=true;b.pager_count=this.conowingoCount;if(this.conowingoNewest>this.newest)this.newest=this.conowingoNewest;var c=bagofholding,d=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');CSS.addClass(d,'async_saving');var e=a.childNodes.length;if(this.conowingoCount==e){c=function(){CSS.hide(d);this.shiftPrefetchStories();}.bind(this);}else if(this.conowingoCount>20){b.replace_pager=true;b.delay_load_count=20-e;}this.slideIn(a,d,c);this.refresh(UIIntentionalStream.REFRESH_BUBBLE,b,{});};UIIntentionalStream.prototype.showRecentStoriesPager=function(a){if(!a)return;this.verifyPagerStyling();animation(a).from('opacity',0).to('opacity',1).show().ondone(function(){Arbiter.inform('reflow');}).go();new AsyncSignal('/ajax/feed/show_pager.php',{count:this.conowingoCount}).send();};UIIntentionalStream.prototype.verifyPagerStyling=function(){if(!this.shouldRenderCount)return;DOM.prependContent(this.streamContent,$N('li'));};UIIntentionalStream.prototype.slideIn=function(a,b,c){var d=a.parentNode,e=$N('div',{style:{marginTop:'-10000px'}},a),f=$N('div',{style:{overflow:'hidden'}},e);CSS.setStyle(e,'opacity',0);CSS.show(a);DOM.prependContent(d,f);var g=Vector2.getElementDimensions(e).y;CSS.setStyle(e,'marginTop','-'+g+'px');animation(b).from('opacity',1).to('opacity',0).ondone(function(){var h=b.offsetHeight;CSS.setStyle(e,'paddingBottom',h+'px');CSS.hide(b);animation(e).duration(1000).to('marginTop',0).to('paddingBottom',0).to('opacity',1).ease(animation.ease.both).ondone(function(){DOM.replace(f,a);c();}).go();}).go();};UIIntentionalStream.prototype.shiftPrefetchStories=function(){var a=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer');if(!a.childNodes.length)return;DOM.prependContent(this.streamContent,$A(a.childNodes));CSS.hide(a);var b=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');CSS.removeClass(b,'async_saving');Arbiter.inform('reflow');};UIIntentionalStream.prototype.checkScroll=function(){if(this.scrollListener&&Vector2.getScrollPosition().y>0){new AsyncSignal('/ajax/feed/scroll_detect.php').send();this.scrollListener.remove();this.scrollListener=null;}};UIIntentionalStream.prototype.getCurrentParams=function(){var a={},b=URI.getMostRecentURI().getQueryData();b.filter=this.getCurrentFilterKey();var c=this.getValidParams();if(c){c.forEach(function(d){a[d]=b[d];});}else a=b;return a;};UIIntentionalStream.prototype.setHomeFilter=function(a){this._homeFilter=a;};UIIntentionalStream.prototype.setHomeFilterLoading=function(a){if(this._homeFilter)this._homeFilter.setLoading(a);};UIIntentionalStream.prototype.setConowingoCount=function(a){this.conowingoCount=a;this.shouldRenderCount=!!this.conowingoCount;};UIIntentionalStream.prototype.setConowingoNewest=function(a){if(a>this.conowingoNewest)this.conowingoNewest=a;};UIIntentionalStream.prototype.updateRecentStoryCount=function(a){this.setConowingoCount(a);var b=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');if(this.shouldRenderCount){var c=DOM.find(b,'span.fbStreamRecentStoriesText'),d;if(this.conowingoCount==1){d=tx._("{count} NEW STORY",{count:a});}else if(a<=100){d=tx._("{count} NEW STORIES",{count:a});}else d="100+ NEW STORIES";DOM.setContent(c,d);if(CSS.hasClass(b,'hidden_elem'))this.showRecentStoriesPager(b);}else CSS.hide(b);};UIIntentionalStream.prototype.updateRenderedStories=function(a){if(this.shouldRenderCount){var b=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer');DOM.setContent(b,HTML(a));}};UIIntentionalStream.prototype.incrementTransitionalNux=function(a){if(this.incrementedTransitionalNux)return;this.incrementedTransitionalNux=true;var b='/ajax/feed/nux/transitional_increment',c={location:a};new AsyncSignal(b,c).send();};UIIntentionalStream.prototype.refresh=function(a,b,c){Arbiter.inform(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME);this.currentFilterKey=b.filter;if(b.filter==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED){this.currentFilterKey=this.defaultFilter;}else if(UIIntentionalStream.isHighlightsFilter(b.filter)||b.filter===UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED)this.defaultFilter=this.currentFilterKey;c=c||{};var d=++this.requestNum,e=coalesce(c.showLoader,true),f=this.instanceName,g=function(k){UIIntentionalStream.getInstance(f).handleResponse(d,a,k,c);},h=function(k){UIIntentionalStream.getInstance(f).handleError(d,a,k,c);},i=function(k){UIIntentionalStream.getInstance(f).handleFinally(a,b.filter,k);};if(!(b.request_type=a))b.request_type='none';if(b.filter){c.show_hidden=b.show_hidden?b.show_hidden:false;}else c.show_hidden=this.shouldShowHidden;b=copy_properties(this.getCurrentParams(),b);this.hasPendingRefresh=true;var j;if(a==UIIntentionalStream.REFRESH_APPEND&&e)j=this.pager;new AsyncRequest().setURI(this.getEndpoint()).setReadOnly(true).setOption('retries',0).setMethod(this.getRefreshMethod()).setData(b).setHandler(g).setStatusElement(j).setErrorHandler(h).setFinallyHandler(i).send();if(a==UIIntentionalStream.REFRESH_TRANSITION){hide(this.pager);this.clearScrollLoader(true);this.oldest=this.newest=null;}if(e)this.setHomeFilterLoading(true);};UIIntentionalStream.prototype.addComposerContent=function(a,b){if(this.isOnNewsFeedFilter())CSS.addClass(a,'uiStreamBoulderHighlight');this.addContentPrepend(a,b);};UIIntentionalStream.prototype.addContentPrepend=function(a,b){if(a.length){$A(a).reverse().forEach(function(h){this.addContentPrepend(h,b);}.bind(this));return;}var c,d=Vector2.getScrollPosition().y,e=Vector2.getElementPosition(this.streamContent).y,f=this.scrollOnPrepend&&d>=e;if(f){var g=function(h){var i=DOM.find(h,'^li.uiStreamStory');if(!i)return;DataStore.set(i,'origHeight',i.offsetHeight);Event.listen(h,'load',function(){var j=DataStore.get(i,'origHeight');if(i.offsetHeight!=j){window.scrollBy(0,i.offsetHeight-j);DataStore.set(i,'origHeight',i.offsetHeight);}});};c=animation.insert.curry(this.streamContent,a,(function(h,i){DOM.prependContent(this.streamContent,i);Arbiter.inform('reflow');window.scrollBy(0,i.offsetHeight);DOM.scry(i,'img').forEach(g);}).bind(this));}else c=(function(){CSS.setStyle(a,'opacity',0);DOM.prependContent(this.streamContent,a);Arbiter.inform('reflow');animation(a).from('opacity',0).to('opacity',1).duration(400).go();}).bind(this);if(b){setTimeout(c,b);}else c();};UIIntentionalStream.prototype.addContentAppend=function(a){DOM.appendContent(this.streamContent,a);};UIIntentionalStream.getStoriesByAssoc=function(a){return DOM.scry(UIIntentionalStream.instance.root,'div.aid_'+a);};UIIntentionalStream.prototype.handleResponse=function(a,b,c,d){d=d||{};var e=c.getPayload();this.filterNullState&&DOM.remove(this.filterNullState);if(is_empty(e))return;if(e.autoRefreshConfig)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,e.autoRefreshConfig);this.setHomeFilterLoading(false);if(b==UIIntentionalStream.REFRESH_EXPAND){var f=DOM.find($(d.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.hide(f);CSS.removeClass(f,'UIIntentionalStory_CollapsedStoriesLoading');}if(this.error)hide(this.error);if(a!=this.requestNum)return;if('show_hidden' in d)this.shouldShowHidden=d.show_hidden;if('newestStoryTime' in e&&e.newestStoryTime>this.newest)this.newest=e.newestStoryTime;if('oldestStoryTime' in e&&(!this.oldest||e.oldestStoryTime<this.oldest))this.oldest=e.oldestStoryTime;if('conowingoCount' in e){this.updateRecentStoryCount(e.conowingoCount);if('conowingoHTML' in e)this.updateRenderedStories(e.conowingoHTML);if('conowingoNewest' in e)this.setConowingoNewest(e.conowingoNewest);}if(!e.html){if(b==UIIntentionalStream.REFRESH_BUBBLE){this.shiftPrefetchStories();Arbiter.inform(UIIntentionalStreamMessage.UPDATE_HTML_CONTENT);}}else{var g=HTML(e.html).getNodes();switch(b){case UIIntentionalStream.REFRESH_BUBBLE:if(e.replaceCurrentStories){DOM.empty(this.streamContent);this.scrollPosition=e.scrollPosition;this.lastViewStateID=e.lastViewStateID;this.oldest=e.oldestStoryTime;}this.addContentPrepend(g);this.shiftPrefetchStories();break;case UIIntentionalStream.REFRESH_COUNT:case UIIntentionalStream.REFRESH_PREPEND:this.addContentPrepend(g);break;case UIIntentionalStream.REFRESH_APPEND:this.addContentAppend(g);this.clearScrollLoader(true);break;case UIIntentionalStream.REFRESH_TRANSITION:DOM.setContent(this.streamContent,g);var h=this.streamContent.firstChild;if(!d.noScroll)DOMScroll.scrollTo(new Vector2(0,0,"document"),false);break;case UIIntentionalStream.REFRESH_EXPAND:DOM.insertAfter($(d.expandStoryID),g);break;case UIIntentionalStream.DELAYED_STREAM:this.addContentAppend(g);break;}this.verifyPagerStyling();Arbiter.inform(UIIntentionalStreamMessage.UPDATE_HTML_CONTENT);}};UIIntentionalStream.prototype.handleError=function(a,b,c,d){if(a!=this.requestNum)return;this.setHomeFilterLoading(false);var e=c.getError();if(e==1357001)AsyncResponse.defaultErrorHandler(c);if(b==UIIntentionalStream.REFRESH_EXPAND){var f=DOM.find($(d.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.removeClass(f,'UIIntentionalStory_CollapsedStoriesLoading');}if(!d.delayLoadCount&&b!=UIIntentionalStream.REFRESH_PREPEND&&this.error)CSS.setStyle(this.error,'display','block');};UIIntentionalStream.prototype.handleFinally=function(a,b){if(a==UIIntentionalStream.REFRESH_TRANSITION){PageTransitions.transitionComplete();Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED);}this.hasPendingRefresh=false;};UIIntentionalStream.prototype.getValidParams=function(){return UIIntentionalStream.VALID_PARAMS;};UIIntentionalStream.prototype.getEndpoint=function(){return UIIntentionalStream.ENDPOINT;};UIIntentionalStream.prototype.getRefreshMethod=function(){return UIIntentionalStream.REFRESH_METHOD;};UIIntentionalStream.prototype.isOnNewHighlights=function(){var a=this.getCurrentFilterKey();return (UIIntentionalStream.isHighlightsFilter(a)||(a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED&&UIIntentionalStream.isHighlightsFilter(this.defaultFilter)));};UIIntentionalStream.prototype.isLiveStreamBox=function(){var a=this.getCurrentFilterKey();return a&&a.indexOf(UIIntentionalStream.FEED_FILTER_KEY_LIVE_STREAM_BOX)==0;};UIIntentionalStream.prototype.isOnNewsFeedFilter=function(){var a=this.getCurrentFilterKey();return (a==UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED||UIIntentionalStream.isHighlightsFilter(a)||a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED);};UIIntentionalStream.prototype.setupAutoInsert=function(){Arbiter.subscribe(UIIntentionalStreamMessage.SET_AUTO_INSERT,UIIntentionalStream.setAutoInsert);};UIIntentionalStream.setAutoInsert=function(a,b){if(a!=UIIntentionalStreamMessage.SET_AUTO_INSERT)return;var c=UIIntentionalStream.instance;if(c)c.pauseAutoInsert=b.pause;};UIIntentionalStream.prototype.isAutoRefreshPaused=function(){if(this.isOnNewHighlights()||this.isLiveStreamBox())return false;return this.pauseAutoInsert;};UIIntentionalStream.prototype.refreshStream=function(a,b){if(a!=UIIntentionalStreamMessage.REFRESH_STREAM)return;var c=this.getCurrentFilterKey();if(this.isOnNewsFeedFilter()&&b.shouldOverride)c=UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS;var d=UIIntentionalStream.isHighlightsFilter(c),e={filter:c};if(d)e.pending=d;var f={filter:c};b.noScroll&&(f.noScroll=1);this.refresh(UIIntentionalStream.REFRESH_TRANSITION,e,f);};copy_properties(UIIntentionalStream,{ANIMATION_DURATION:300,REFRESH_METHOD:'GET',REFRESH_TRANSITION:1,REFRESH_PREPEND:2,REFRESH_APPEND:3,REFRESH_COUNT:4,REFRESH_EXPAND:5,DELAYED_STREAM:6,REFRESH_BUBBLE:7,FEED_FILTER_KEY_NEW_HIGHLIGHTS:'h',FEED_FILTER_KEY_NEWS_FEED:'lf',FEED_FILTER_KEY_DUAL_NEWS_FEED:'nf',FEED_FILTER_KEY_LIVE_STREAM_BOX:'pub',VALID_PARAMS:['filter','show_hidden'],ENDPOINT:'/ajax/intent.php'});
function UIIntentionalStreamRefresh(a,b){copy_properties(this,{isAutoRefreshing:false,lastRefresh:Date.now()});UIIntentionalStreamRefresh.instance=this;this.setAutoRefreshConfig(a);this.updateConfigHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,this.updateAutoRefreshConfig.bind(this));this.updateRefreshTimeHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME,this.updateLastRefreshTime.bind(this));onleaveRegister(this.unload.bind(this));this.userActivity();this.uaToken=UserActivity.subscribe(this.userActivity.bind(this));this.autoRefreshInterval=setInterval(this.checkAutoPageRefresh.bind(this),this.checkAutoRefreshTimeInterval);this.activeRefreshInterval=setInterval(this.checkActiveRefresh.bind(this),this.checkActiveRefreshTimeInterval);this.enableAutoRefresh(b);Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,LiveTimer.loop.bind(LiveTimer,true));Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,LiveTimer.loop.bind(LiveTimer,true));if(this.usePresence)UIIntentionalStreamRefresh.presenceRegister();}copy_properties(UIIntentionalStreamRefresh,{_presenceInit:false,DISABLE_AUTOREFRESH_TIME:4*60*1000,CHECK_AUTOREFRESH_INTERVAL:5*60*1000,AUTOREFRESH_INACTIVE_TIME:30*60*1000,HIGHLIGHTS_OVERRIDE_TIME:360*60*1000,CHECK_ACTIVE_REFRESH_TIME:5*60*1000,ACTIVE_REFRESH_TIME:30*1000});UIIntentionalStreamRefresh.presenceRegister=function(){if(UIIntentionalStreamRefresh._presenceInit)return true;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('feedpub'),UIIntentionalStreamRefresh.handleNewStoryMessage);UIIntentionalStreamRefresh._presenceInit=true;};UIIntentionalStreamRefresh.prototype.updateAutoRefreshConfig=function(a,b){if(a==UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG)this.setAutoRefreshConfig(b);};UIIntentionalStreamRefresh.prototype.updateLastRefreshTime=function(a){if(a==UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME)this.lastRefresh=Date.now();};UIIntentionalStreamRefresh.prototype.setAutoRefreshConfig=function(a){a=a||{};var b=24*60*60*1000;if(!this.storyInterval)this.storyInterval=coalesce(a.story_interval,null);this.allowAutoRefresh=coalesce(a.allow_auto_refresh,false);this.inactiveThreshold=coalesce(a.inactive_threshold,0);this.activeRefreshTime=coalesce(a.fast_refresh_rate,b);this.inactiveRefreshTime=coalesce(a.slow_refresh_rate,b);this.allowPolling=coalesce(a.allow_polling,false);this.refreshFactor=coalesce(a.refresh_factor,10);this.minRefreshInterval=coalesce(a.min_refresh_interval,60*1000);this.usePresence=coalesce(a.use_presence,false);this.activeRefresh=coalesce(a.active_refresh,false);this.checkActiveRefreshTimeInterval=coalesce(a.check_active_refresh_interval,UIIntentionalStreamRefresh.CHECK_ACTIVE_REFRESH_TIME);this.activeRefreshTimeInterval=coalesce(a.active_refresh_interval,UIIntentionalStreamRefresh.ACTIVE_REFRESH_TIME);this.disableAutoRefreshTime=coalesce(a.disable_autorefresh_time,UIIntentionalStreamRefresh.DISABLE_AUTOREFRESH_TIME);this.checkAutoRefreshTimeInterval=coalesce(a.check_autorefresh_time_interval,UIIntentionalStreamRefresh.CHECK_AUTOREFRESH_INTERVAL);this.autoRefreshInactiveTime=coalesce(a.autorefresh_inactive_time,UIIntentionalStreamRefresh.AUTOREFRESH_INACTIVE_TIME);this.highlightsOverrideTime=coalesce(a.highlights_override_time,UIIntentionalStreamRefresh.HIGHLIGHTS_OVERRIDE_TIME);return this;};UIIntentionalStreamRefresh.prototype.unload=function(){this.enableAutoRefresh(false);this.cleanupRefreshInterval();UserActivity.unsubscribe(this.uaToken);this.updateConfigHandler&&Arbiter.unsubscribe(this.updateConfigHandler);this.updateRefreshTimeHandler&&Arbiter.unsubscribe(this.updateRefreshTimeHandler);};UIIntentionalStreamRefresh.prototype.userActivity=function(){var a=this.isInactive();this.lastActivity=Date.now();this.isAutoRefreshing=true;if(a&&this.canAutoRefresh())this.runAutoRefresh();return true;};UIIntentionalStreamRefresh.prototype.isInactive=function(){return this.getMSSinceLastActivity()>this.inactiveThreshold;};UIIntentionalStreamRefresh.prototype.getMSSinceLastActivity=function(){return Date.now()-this.lastActivity;};UIIntentionalStreamRefresh.prototype.getMSSinceLastRefresh=function(){return Date.now()-this.lastRefresh;};UIIntentionalStreamRefresh.prototype.getRefreshInterval=function(){if(this.isInactive()){return this.inactiveRefreshTime;}else if(this.storyInterval!=null){var a=this.storyInterval*this.refreshFactor;return Math.max(a,this.activeRefreshTime);}else return this.activeRefreshTime;};UIIntentionalStreamRefresh.prototype.canAutoRefresh=function(){return this.isAutoRefreshing&&this.allowAutoRefresh;};UIIntentionalStreamRefresh.handleNewStoryMessage=function(a,b){if(a!=PresenceMessage.getArbiterMessageType('feedpub'))return;Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cancelUpdate=function(){if(this.updateTask){clearTimeout(this.updateTask);this.updateTask=null;}};UIIntentionalStreamRefresh.prototype.runUpdatePoll=function(){this.updateTask=null;if(this.canAutoRefresh())this.runAutoRefresh();};UIIntentionalStreamRefresh.prototype.runAutoRefresh=function(){var a=50;if(this.getMSSinceLastRefresh()>=this.minRefreshInterval-a)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);this.schedulePoll(this.getRefreshInterval());};UIIntentionalStreamRefresh.prototype.schedulePoll=function(a){this.cancelUpdate();if(this.allowPolling)this.updateTask=setTimeout(this.runUpdatePoll.bind(this),a);};UIIntentionalStreamRefresh.prototype.enableAutoRefresh=function(a,b){this.isAutoRefreshing=a;if(a){var c=b?0:this.getRefreshInterval();this.schedulePoll(c);}else this.cancelUpdate();};UIIntentionalStreamRefresh.prototype.checkAutoPageRefresh=function(){if(!this.allowAutoRefresh)return;if(this.isAutoRefreshing&&(this.getMSSinceLastActivity()>this.disableAutoRefreshTime))this.isAutoRefreshing=false;if(this.getMSSinceLastRefresh()<this.autoRefreshInactiveTime)return;var a=this.getMSSinceLastActivity();if(a>this.autoRefreshInactiveTime){var b=(a>this.highlightsOverrideTime);Arbiter.inform(UIIntentionalStreamMessage.REFRESH_STREAM,{shouldOverride:b});}};UIIntentionalStreamRefresh.prototype.checkActiveRefresh=function(){if(!this.allowAutoRefresh)return;if(this.getMSSinceLastRefresh()<this.activeRefreshTimeInterval)return;if(this.getMSSinceLastActivity()<this.activeRefreshTimeInterval)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cleanupRefreshInterval=function(){if(this.autoRefreshInterval){clearInterval(this.autoRefreshInterval);this.autoRefreshInterval=null;}};
add_properties('TypeaheadBehaviors',{ie6Hacks:function(a){a.subscribe('init',function(){var b=new IframeShim(a.getView().getElement());a.subscribe(['reset','blur'],b.hide.bind(b));a.subscribe(['render','focus'],b.show.bind(b));});}});