(function(){AO.models.DesignImage=Backbone.Model.extend({defaults:{id:null,position:0,onepage_template_id:0,preview_url:null,original_url:null}}),AO.views.BgImageEditor=Backbone.View.extend({initialize:function(){this.file_filds=[],this.render()},render:function(){var t=_.template($("#bg-image-editor-template").html(),{title:"Banners"});this.$el.html(t);for(var e=$.parseJSON($("#top_banner_images_data").html()),i=0;i<e.length;i++)this.file_filds[i]=new AO.views.ImageEditorFileField({model:new AO.models.DesignImage(e[i])}),this.$el.find(".ao-bg-image-editor-file-fiels").append(this.file_filds[i].render().el)}}),AO.views.ImageEditorFileField=Backbone.View.extend({className:"ao-bg-image-editor-button",events:{"click .ao-uploaded-design-image-delete a":"deleteImage"},initialize:function(t){this.id=null,this.url=t.url||"/"},initForm:function(){var t=this;this.formEl=this.$el.find(".upload_image"),this.bar=this.$el.find(".bar"),this.percent=this.$el.find(".percent"),this.progressBar=this.$el.find(".progress"),this.methodFld=this.$el.find(".request_method"),this.idFld=this.$el.find(".id_fld"),this.uploaded=this.$el.find(".ao-uploaded-design-image"),this.uploaded_image=this.$el.find(".ao-uploaded-design-image-src"),this.delete_uploaded=this.$el.find(".ao-uploaded-design-image-delete"),this.delete_uploaded_processing=this.$el.find(".ao-delete-uploaded-design-image-processing"),this.formEl.ajaxForm({url:"/onepage/top_banner_images",type:"POST",beforeSerialize:function(){t.hasId()?(this.url="/onepage/top_banner_images/"+t.id,t.methodFld.val("PUT")):t.methodFld.val("POST")},beforeSend:function(){var e="0%";t.bar.width(e),t.percent.html(e),t.formEl.hide(),t.progressBar.show()},uploadProgress:function(e,i,s,a){var n=a+"%";t.bar.width(n),t.percent.html(n)},success:function(e){e=$.parseJSON(e),e.status&&(t.uploaded.parent().addClass("loaded"),t.uploaded.show(),t.uploaded_image.html("<img src='"+e.image.preview_url+"'/>"),e.image.id!=void 0&&t.model.set("id",e.image.id),AO.core.events.trigger("top_page:set:banner",e.image.position,e.image.original_url))},complete:function(){t.formEl.show(),t.progressBar.hide()},error:function(){}}),this.formEl.find(".upload-file-image").change(function(){t.formEl.submit()})},render:function(){var t=_.template($("#bg-image-editor-file-field-template").html(),this.model.toJSON());this.$el.html(t),this.initForm();var e=parseInt(this.model.get("id"),10);return isNaN(e)||(this.uploaded.parent().addClass("loaded"),this.uploaded.show(),this.uploaded_image.html("<img src='"+this.model.get("preview_url")+"'/>")),this},deleteImage:function(){var t=this;this.showDeleteProcess(),this.model.destroy({url:"/onepage/top_banner_images/"+t.model.get("id"),success:function(){t.uploaded.hide(),t.uploaded_image.empty(),t.model.set("id",null),t.hideDeleteProcess(),AO.core.events.trigger("top_page:set:default_banner",t.model.get("position")),t.uploaded.parent().removeClass("loaded")},error:function(){t.hideDeleteProcess()}})},showDeleteProcess:function(){this.delete_uploaded.hide(),this.delete_uploaded_processing.show(),this.uploaded.parent().removeClass("loaded")},hideDeleteProcess:function(){this.delete_uploaded.show(),this.delete_uploaded_processing.hide()},hasId:function(){var t=!1,e=parseInt(this.model.get("id"),10);return isNaN(e)?this.id=null:(t=!0,this.id=e),t}})})();