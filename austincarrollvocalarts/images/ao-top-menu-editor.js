(function(){AO.models.EditorMenuItem=Backbone.Model.extend({defaults:{id:null,name:"Name",position:null,status:!0,asset:"#!/top-page",menu_type:"page"},shortName:function(){var e=this.get("name");return e},toJSON:function(){var e=_.clone(this.attributes),t={menu:{id:e.id,menu_type:e.menu_type,name:e.name,asset:e.asset,short_name:this.shortName(),status:e.status}};return e.ret_data!=void 0&&(t.menu.ret_data=e.ret_data),t},isLink:function(){return this.get("menu_type")=="url"?!0:!1},parse:function(e){return(e.status==void 0||e.status)&&e.status!=void 0&&e.status&&(e=e.data),e},saveItem:function(e,t,i){i=i||{},t=t||{};var s={menu:{}},a=0,n=e.length;if(e){for(a=0;n>a;a++)s.menu[e[a]]=this.get(e[a]);for(var o in t)s.menu[o]=t[o];i.data=JSON.stringify(s)}else i.data=this.toJSON();return i.contentType="application/json",Backbone.Model.prototype.save.call(this,t,i)},savePosition:function(e){e=e||{};var t={item:{id:this.get("id"),position:this.get("position")}};return e.data=JSON.stringify(t),e.contentType="application/json",Backbone.Model.prototype.save.call(this,{},e)}}),AO.collections.EditorMenuItems=Backbone.Collection.extend({model:AO.models.EditorMenuItem}),AO.views.TopMenuEditor.Item=Backbone.View.extend({className:"top-menu-editor-list-item",events:{"click .ao-edit-menu-item":"showEdit","click .top-menu-editor-list-item-edit-form form input[type=button]":"hideEdit","dblclick .menu-list-item-short-name":"showEdit","submit .top-menu-editor-list-item-edit-form form":"saveEdit","keyup input.top-menu-editor-edit-item-name":"editingName","click form input[type=button]":"cancelEdit","click a.ao-hide-menu-item":"hideItem","click a.ao-delete-menu-item":"deleteItem",drop:"drop"},initialize:function(){},render:function(){var e=_.template($("#top_menu_item_editor_template").html(),this.model.toJSON());return this.$el.html(e),this.actionEl=this.$el.find(".top-menu-editor-list-item-action"),this.formEl=this.$el.find(".top-menu-editor-list-item-edit-form"),this.formItemNameEl=this.$el.find(".top-menu-editor-edit-item-name"),this.formItemLinkEl=this.model.isLink?this.$el.find(".top-menu-editor-edit-item-link"):null,this.listItemUrlEl=this.$el.find(".menu-list-item-url"),this.listItemNameEl=this.$el.find(".menu-list-item-name"),this.listItemShortNameEl=this.$el.find(".menu-list-item-short-name"),this.loading=this.$el.find(".ao-menu-list-item-action-loading"),this.action=this.$el.find(".ao-menu-list-item-action"),this.itemDataEl=this.$el.find(".ao-top-menu-editor-item-data"),this.formSubmitContainer=this.$el.find(".ao-menu-add-form-item-submit"),this.formLoading=this.$el.find(".ao-menu-add-form-item-loading"),this},showEdit:function(){this.actionEl.hide(),this.formEl.show()},hideEdit:function(){this.actionEl.show(),this.formEl.hide()},saveEdit:function(){var e=this,t=["id","name"];return this.model.set("name",this.formItemNameEl.val()),this.model.url="/menu",this.listItemNameEl.html(this.model.get("name")),this.listItemShortNameEl.html(this.model.shortName()),AO.core.events.trigger("top_menu:item:edit:name:"+this.model.get("id"),this.formItemNameEl.val()),this.model.isLink&&(AO.core.events.trigger("top_menu:item:edit:url:"+this.model.get("id"),this.formItemLinkEl.val()),this.listItemUrlEl.html(this.formItemLinkEl.val()),this.model.set("asset",this.formItemLinkEl.val()),t.push("asset")),this.showFormLoading(),this.model.saveItem(t,{ret_data:"ops_item"},{success:function(){e.hideFormLoading(),e.hideEdit(),AO.core.events.trigger("notify:success","Test text")},error:function(){e.hideFormLoading()}}),!1},cancelEdit:function(){this.listItemNameEl.html(this.model.get("name")),this.listItemShortNameEl.html(this.model.shortName()),this.formItemNameEl.val(this.model.get("name")),AO.core.events.trigger("top_menu:item:edit:name:"+this.model.get("id"),this.model.get("name")),this.model.isLink&&(AO.core.events.trigger("top_menu:item:edit:url:"+this.model.get("id"),this.model.get("asset")),this.listItemUrlEl.html(this.model.get("asset")),this.formItemLinkEl.val(this.model.get("asset"))),this.hideEdit()},editingName:function(){AO.core.events.trigger("top_menu:item:edit:name:"+this.model.get("id"),this.formItemNameEl.val())},drop:function(e,t){this.model.set("position",parseInt(t,10)+1),this.model.savePosition({url:"/menu/move_menu",success:function(){},error:function(){}});var i=null,s=1,a=this.$el.next(),n=2,o=null,r="",l="",d=null,h=AO.modules.helpers.urlToPageSectionId(this.model.get("asset"));if(a.length==0&&(a=this.$el.prev(),s=-1),i=parseInt(a.find(".menu-list-item-id").attr("data-menu-item-id"),10),AO.core.events.trigger("top_menu:move:item",this.model.get("id"),i,s),AO.modules.helpers.allowMovePageSection(this.model.get("type"),this.model.get("asset"))){for(;n>0;)i=parseInt(a.find(".menu-list-item-id").attr("data-menu-item-id"),10),o=a.find(".menu-list-item-name").html(),r=a.find(".menu-list-item-url").html(),l=a.find(".menu-list-item-type").attr("data-menu-item-type"),d=AO.modules.helpers.urlToPageSectionId(r),AO.modules.helpers.allowMovePageSection(l,r)&&(n=0),2==n?(a=a.next(),s=1):1==n&&(a=a.prev(),s=-1),a.length==0&&(n-=1,1==n&&(a=this.$el.prev()));AO.core.events.trigger("page_manager:section:move",h,d,s)}},hideItem:function(){var e=this.model.get("status"),t=this;return this.showLoading(),e=!e,this.model.url="/menu",this.model.set("status",e),this.model.saveItem(["id","status"],{ret_data:"ops_item"},{success:function(){t.hideLoading(),e?t.removeHideClass():t.addHideClass(),AO.core.events.trigger("top_menu:item:hide:"+t.model.get("id")),e?AO.core.events.trigger("page_manager:section:show:"+t.model.get("id")):AO.core.events.trigger("page_manager:section:hide:"+t.model.get("id"))},error:function(){t.hideLoading()}}),!1},showLoading:function(){this.loading.show(),this.action.hide()},hideLoading:function(){this.loading.hide(),this.action.show()},addHideClass:function(){this.itemDataEl.addClass("ao-top-menu-editor-item-hidden"),this.$el.find(".ao-hide-menu-item .glyphicon.hidden").removeClass("hidden").siblings().addClass("hidden")},removeHideClass:function(){this.itemDataEl.removeClass("ao-top-menu-editor-item-hidden"),this.$el.find(".ao-hide-menu-item .glyphicon.hidden").removeClass("hidden").siblings().addClass("hidden")},showFormLoading:function(){this.formSubmitContainer.hide(),this.formLoading.show()},hideFormLoading:function(){this.formSubmitContainer.show(),this.formLoading.hide()},deleteItem:function(){var e=this,t=this.model.get("id");this.model.url="/menu/"+t,this.model.destroy({success:function(){e.destroyView(),AO.core.events.trigger("top_menu:item:delete:"+t),AO.core.events.trigger("content:delete:"+t)},error:function(){}})},destroyView:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)}}),AO.views.TopMenuEditor.List=Backbone.View.extend({initialize:function(){AO.core.events.on("top_menu:add:new:item",$.proxy(this.addNewItem,this)),this.render()},render:function(){this.collection.each(function(e){var t=new AO.views.TopMenuEditor.Item({model:e});this.$el.append(t.render().el)},this),this.$el.sortable({stop:function(e,t){t.item.trigger("drop",t.item.index())}})},addNewItem:function(e){var t=new AO.models.EditorMenuItem(e),i=new AO.views.TopMenuEditor.Item({model:t});this.$el.append(i.render().el)}}),AO.models.NewMenuItem=Backbone.Model.extend({defaults:{id:null,name:null,asset:null,menu_type:null},initialize:function(){this.responseErrors=null},validate:function(e){var t=[];return e.name&&e.name.match(/\S/)||t.push({name:"name",message:"Please fill name field."}),e.menu_type&&e.menu_type=="url"&&(e.asset&&e.asset.match(/^(ht|f)tps?:\/\/[a-z0-9-\.]+\.[a-z]{2,4}\/?([^\s<>\#%"\,\{\}\\|\\\^\[\]`]+)?$/)||t.push({name:"link",message:"Please fill link field."})),t.length>0?t:!1},toJSON:function(){return{menu:_.clone(this.attributes)}},parse:function(e){return(e.status==void 0||e.status)&&e.status!=void 0&&e.status&&(e=e.data),e}}),AO.views.TopMenuEditor.AddForm=Backbone.View.extend({events:{"submit form":"submitForm","click a.add-new":"showForm","click form input[type=button]":"cancelForm","change .new-menu-item-type":"changeType"},initialize:function(){this.model=null,this.render()},render:function(){var e=_.template($("#top_menu_editor_add_new_item_form").html()),t=this;this.$el.html(e),this.form=this.$el.find("form").hide(),this.addLink=this.$el.find("a.add-new"),this.typeEl=this.$el.find(".new-menu-item-type"),this.nameEl=this.$el.find(".new-menu-item-name"),this.linkEl=this.$el.find(".new-menu-item-link"),this.errorEl={name:t.$el.find(".new-menu-item-name-error"),link:t.$el.find(".new-menu-item-link-error")},this.formSubmitContainer=this.$el.find(".ao-menu-add-form-item-submit"),this.formLoading=this.$el.find(".ao-menu-add-form-item-loading")},showForm:function(){this.form.is(":visible")?(this.addLink.hide(),this.form.hide()):(this.form.show(),this.addLink.hide())},clearErrors:function(){for(var e in this.errorEl)this.errorEl[e].val!=void 0&&this.errorEl[e].empty()},showError:function(e){console.log("render error"),console.log(e);var t=e.length,i=0;for(i;t>i;i++)console.log(this.errorEl[e[i].name]),this.errorEl[e[i].name]!=void 0&&this.errorEl[e[i].name].html(e[i].message)},submitForm:function(){var e=this.typeEl.val(),t=this.linkEl.val(),i=this;return"page"==e&&(t=null),this.model=new AO.models.NewMenuItem({name:this.nameEl.val(),asset:t,menu_type:this.typeEl.val()}),this.showFormLoading(),this.model.on("invalid",function(e,t){i.showError(t),i.hideFormLoading()}),this.model.url="/menu",this.model.save({ret_data:"ops_item"},{success:function(){i.successCreated(),i.hideFormLoading(),i.hideForm(),AO.core.events.trigger("message:notify","success","Success: ","menu item successfully added")},error:function(){AO.core.events.trigger("message:notify","danger","Error: ","Reload page and try again.")}}),!1},successCreated:function(){this.model.set("asset","#!/page/"+this.model.get("id")),AO.core.events.trigger("top_menu:add:new:item",this.model.toJSON().menu),this.model.get("menu_type")=="ops"&&(AO.core.pagesManager.addPage({id:this.model.get("id"),asset:this.model.get("asset"),editor:!0,name:this.model.get("name")}),AO.modules.router.navigate(this.model.get("asset"),{trigger:!0}))},cancelForm:function(){this.hideForm(),this.clearErrors()},hideForm:function(){this.form.hide(),this.addLink.show(),this.nameEl.val(""),this.linkEl.val("")},changeType:function(){var e=this.typeEl.val();"url"==e?this.linkEl.parent().removeClass("display_none"):this.linkEl.parent().addClass("display_none"),this.clearErrors()},showFormLoading:function(){this.formSubmitContainer.hide(),this.formLoading.show()},hideFormLoading:function(){this.formSubmitContainer.show(),this.formLoading.hide()}}),AO.views.TopMenuEditor.Main=Backbone.View.extend({initialize:function(){this.list=new AO.views.TopMenuEditor.List({collection:AO.modules.editorMenuItemsCollection,el:this.$el.find(".items-container")}),this.addForm=new AO.views.TopMenuEditor.AddForm({el:this.$el.find(".add-form-container")})},render:function(){}})})();