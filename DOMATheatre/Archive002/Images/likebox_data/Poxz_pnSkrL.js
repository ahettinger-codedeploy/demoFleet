/*1330398533,176820664*/

if (window.CavalryLogger) { CavalryLogger.start_js(["A7qwk"]); }

__e("KeyEventController",["event-extensions","function-extensions","DOM","Run","Util","copyProperties","isEmpty"],function(a,b,c,d,e,f){b("event-extensions");b("function-extensions");var g=b("DOM"),h=b("Run"),i=b("Util"),j=b("event-extensions").$E,k=b("copyProperties"),l=b("isEmpty");function m(){this.handlers={};document.onkeyup=this.onkeyevent.bind(this,'onkeyup');document.onkeydown=this.onkeyevent.bind(this,'onkeydown');document.onkeypress=this.onkeyevent.bind(this,'onkeypress');}k(m,{instance:null,getInstance:function(){return m.instance||(m.instance=new m());},defaultFilter:function(event,n){event=j(event);return m.filterEventTypes(event,n)&&m.filterEventTargets(event,n)&&m.filterEventModifiers(event,n);},filterEventTypes:function(event,n){if(n==='onkeydown')return true;return false;},filterEventTargets:function(event,n){var o=event.getTarget();return !g.isNodeOfType(o,m._interactiveElements)||(o.type in m._uninterestingTypes)||(g.isNodeOfType(o,['input','textarea'])&&o.value.length===0&&event.keyCode in m._controlKeys);},filterEventModifiers:function(event,n){if(event.ctrlKey||event.altKey||event.metaKey||event.repeat)return false;return true;},registerKey:function(n,o,p,q){if(p===undefined)p=m.defaultFilter;var r=m.getInstance(),s=r.mapKey(n);if(l(r.handlers))h.onLeave(r.resetHandlers.bind(r));for(var t=0;t<s.length;t++){n=s[t];if(!r.handlers[n]||q)r.handlers[n]=[];r.handlers[n].push({callback:o,filter:p});}},keyCodeMap:{BACKSPACE:[8],TAB:[9],RETURN:[13],ESCAPE:[27],LEFT:[37,63234],UP:[38,63232],RIGHT:[39,63235],DOWN:[40,63233],DELETE:[46],COMMA:[188],PERIOD:[190],'`':[192],'[':[219],']':[221]},_interactiveElements:['input','select','textarea','object','embed'],_uninterestingTypes:{checkbox:1,radio:1,submit:1},_controlKeys:{8:1,9:1,13:1,27:1,37:1,63234:1,38:1,63232:1,39:1,63235:1,40:1,63233:1,46:1}});k(m.prototype,{mapKey:function(n){if(n>=0&&n<=9){if(typeof(n)!='number')n=n.charCodeAt(0)-48;return [48+n,96+n];}var o=m.keyCodeMap[n.toUpperCase()];if(o)return o;return [n.toUpperCase().charCodeAt(0)];},onkeyevent:function(n,o){o=j(o);var p=this.handlers[o.keyCode],q,r,s;if(p)for(var t=0;t<p.length;t++){q=p[t].callback;r=p[t].filter;try{if(!r||r(o,n)){s=q(o,n);if(s===false)return Event.kill(o);}}catch(u){}}return true;},resetHandlers:function(){this.handlers={};}});e.exports=a.KeyEventController||m;});